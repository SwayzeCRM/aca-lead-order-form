<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACA Lead Order System - Admin</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            line-height: 1.5;
            color: #1f2937;
            background-color: #f5f5f5;
            padding: 24px 16px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 32px 40px;
            position: relative;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .header p {
            opacity: 0.9;
            font-size: 16px;
        }

        .admin-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #e74c3c;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .user-info {
            position: absolute;
            top: 50px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-email {
            font-size: 14px;
            opacity: 0.9;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .admin-nav {
            display: flex;
            gap: 0;
            background: #ecf0f1;
            border-bottom: 1px solid #e0e0e0;
        }

        .nav-tab {
            padding: 16px 24px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #7f8c8d;
            transition: all 0.2s ease;
            flex: 1;
            text-align: center;
        }

        .nav-tab.active {
            color: #2c3e50;
            background: white;
            border-bottom-color: #3498db;
        }

        .nav-tab:hover {
            color: #2c3e50;
            background: rgba(255, 255, 255, 0.7);
        }

        .admin-content {
            padding: 40px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 24px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-card.orders {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .stat-card.users {
            background: linear-gradient(135deg, #27ae60, #229954);
        }

        .stat-card.revenue {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .stat-number {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 8px;
            border-bottom: 2px solid #ecf0f1;
        }

        .table-container {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #2c3e50;
            border-bottom: 1px solid #e0e0e0;
            font-size: 14px;
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #f1f1f1;
            font-size: 14px;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-right: 8px;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-processing {
            background: #cce5ff;
            color: #004085;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .status-paid {
            background: #d4edda;
            color: #155724;
        }

        .role-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .role-admin {
            background: #ff6b6b;
            color: white;
        }

        .role-user {
            background: #4ecdc4;
            color: white;
        }

        .role-buyer {
            background: #45b7d1;
            color: white;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #34495e;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .settings-section {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .settings-section h3 {
            color: #2c3e50;
            margin-bottom: 16px;
            font-size: 16px;
            font-weight: 600;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .modal-header h3 {
            margin: 0;
            color: #2c3e50;
            font-size: 18px;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            text-align: right;
        }

        .close-btn {
            background: #95a5a6;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 12px;
        }

        .save-btn {
            background: #27ae60;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .admin-content {
                padding: 20px;
            }

            .admin-nav {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <span class="admin-badge">Admin</span>
            <h1>ACA Lead Order System</h1>
            <p>Administrative Dashboard</p>
            <div class="user-info">
                <span class="user-email" id="adminEmail"></span>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="admin-nav">
            <button class="nav-tab active" onclick="showAdminTab('overview')">Overview</button>
            <button class="nav-tab" onclick="showAdminTab('orders')">Orders</button>
            <button class="nav-tab" onclick="showAdminTab('users')">Users</button>
            <button class="nav-tab" onclick="showAdminTab('integrations')">Integrations</button>
            <button class="nav-tab" onclick="showAdminTab('settings')">Settings</button>
        </div>

        <div class="admin-content">
            <!-- Overview Tab -->
            <div id="overviewTab" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalOrders">-</div>
                        <div class="stat-label">Total Orders</div>
                    </div>
                    <div class="stat-card users">
                        <div class="stat-number" id="totalUsers">-</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                    <div class="stat-card orders">
                        <div class="stat-number" id="pendingOrders">-</div>
                        <div class="stat-label">Pending Orders</div>
                    </div>
                    <div class="stat-card revenue">
                        <div class="stat-number" id="totalRevenue">-</div>
                        <div class="stat-label">Total Revenue</div>
                    </div>
                </div>

                <h2 class="section-title">Recent Activity</h2>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>User</th>
                                <th>Action</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="recentActivity">
                            <tr>
                                <td colspan="5" class="loading">Loading recent activity...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Orders Tab -->
            <div id="ordersTab" class="tab-content">
                <h2 class="section-title">Order Management</h2>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>User</th>
                                <th>Type</th>
                                <th>Quantity</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTable">
                            <tr>
                                <td colspan="8" class="loading">Loading orders...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="usersTab" class="tab-content">
                <h2 class="section-title">User Management</h2>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Location ID</th>
                                <th>Status</th>
                                <th>Joined</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable">
                            <tr>
                                <td colspan="7" class="loading">Loading users...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Integrations Tab -->
            <div id="integrationsTab" class="tab-content">
                <h2 class="section-title">GoHighLevel Integrations</h2>

                <div class="settings-section">
                    <h3>Private Integration Token</h3>
                    <p style="color: #7f8c8d; font-size: 14px; margin-bottom: 16px;">
                        Use this for private GoHighLevel integrations. Private integrations work at the location level and require both a token and Location ID.
                    </p>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Private Integration Token</label>
                            <input type="password" id="ghlPrivateToken" placeholder="pit-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" style="font-family: monospace;">
                            <div class="help-text">Your private integration token (starts with "pit-")</div>
                        </div>
                        <div class="form-group">
                            <label>Location ID</label>
                            <div style="display: flex; gap: 8px; align-items: flex-start;">
                                <input type="text" id="ghlLocationId" placeholder="ve9EPM428h8vShlRW1KT" style="font-family: monospace; flex: 1;">
                                <button type="button" onclick="findLocationId()" class="btn-secondary" style="white-space: nowrap;">Find Location ID</button>
                            </div>
                            <div class="help-text">The GoHighLevel Location ID for this integration</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button class="action-btn btn-primary" onclick="savePrivateIntegration()">Save Integration</button>
                        <button class="action-btn btn-warning" onclick="testContactsAPI()">Test Contacts API</button>
                        <button class="action-btn btn-success" onclick="testOpportunitiesAPI()">Test Opportunities API</button>
                        <button class="action-btn" style="background: #9b59b6; color: white;" onclick="testTagsAPI()">Test Tags API</button>
                        <button class="action-btn" style="background: #27ae60; color: white;" onclick="openFieldMappingModal()">Map Fields</button>
                    </div>
                    <div id="privateTokenResult" style="margin-top: 15px; padding: 12px; border-radius: 4px; display: none;"></div>
                </div>

                <div class="settings-section">
                    <h3>Order Workflow Automation</h3>
                    <p style="color: #7f8c8d; font-size: 14px; margin-bottom: 24px;">
                        Configure what happens automatically in GoHighLevel when a new order is placed. Workflow automation is always enabled.
                    </p>

                    <!-- Contact Management Section -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 24px;">
                        <h4 style="margin: 0 0 16px 0; color: #2c3e50; display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="createUpdateContact" checked style="margin: 0;">
                            Contact Management
                        </h4>
                        <p style="color: #6c757d; margin: 0 0 16px 28px; font-size: 14px;">
                            Create new contact or update existing contact with order information
                        </p>

                        <div style="margin-left: 28px;">
                            <h5 style="margin: 0 0 12px 0; color: #495057;">Field Mapping</h5>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div>
                                    <label style="display: block; margin-bottom: 4px; font-weight: 500;">Customer Name →</label>
                                    <select id="nameFieldMapping" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">Select GoHighLevel field...</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 4px; font-weight: 500;">Customer Email →</label>
                                    <select id="emailFieldMapping" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">Select GoHighLevel field...</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 4px; font-weight: 500;">Customer Phone →</label>
                                    <select id="phoneFieldMapping" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">Select GoHighLevel field...</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 4px; font-weight: 500;">Order Total →</label>
                                    <select id="orderValueFieldMapping" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">Select GoHighLevel field...</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pipeline Management Section -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 24px;">
                        <h4 style="margin: 0 0 16px 0; color: #2c3e50; display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="addToPipeline" style="margin: 0;">
                            Pipeline Management
                        </h4>
                        <p style="color: #6c757d; margin: 0 0 16px 28px; font-size: 14px;">
                            Create opportunity in specified pipeline and stage
                        </p>

                        <div style="margin-left: 28px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 12px;">
                                <div>
                                    <label style="display: block; margin-bottom: 4px; font-weight: 500;">Pipeline *</label>
                                    <select id="pipelineSelect" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" onchange="loadPipelineStages()">
                                        <option value="">Select pipeline...</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 4px; font-weight: 500;">Stage *</label>
                                    <select id="stageSelect" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" disabled>
                                        <option value="">Select pipeline first...</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tagging Section -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 24px;">
                        <h4 style="margin: 0 0 16px 0; color: #2c3e50; display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="addTags" style="margin: 0;">
                            Contact Tagging
                        </h4>
                        <p style="color: #6c757d; margin: 0 0 16px 28px; font-size: 14px;">
                            Add tags to contact when order is placed
                        </p>

                        <div style="margin-left: 28px;">
                            <label style="display: block; margin-bottom: 4px; font-weight: 500;">Tags</label>
                            <div style="position: relative;">
                                <input type="text" id="tagSearchInput" placeholder="Search tags or type to create new..."
                                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                                       oninput="searchTags()" onclick="showTagDropdown()">
                                <div id="tagDropdown" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-top: none; border-radius: 0 0 4px 4px; max-height: 200px; overflow-y: auto; display: none; z-index: 1000;">
                                </div>
                            </div>
                            <div id="selectedTags" style="margin-top: 8px; display: flex; flex-wrap: gap: 6px;">
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 12px; margin-top: 20px;">
                        <button class="action-btn btn-primary" onclick="saveWorkflowSettings()">Save Workflow Settings</button>
                        <button class="action-btn btn-warning" onclick="testWorkflow()">Test Workflow</button>
                    </div>

                    <div id="workflowResult" style="margin-top: 15px; padding: 12px; border-radius: 4px; display: none;"></div>
                </div>

                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Location ID</th>
                                <th>Location Name</th>
                                <th>Status</th>
                                <th>Connected</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="integrationsTable">
                            <tr>
                                <td colspan="5" class="loading">Loading integrations...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settingsTab" class="tab-content">
                <h2 class="section-title">System Settings</h2>

                <div class="settings-section">
                    <h3>General Settings</h3>
                    <div class="form-group">
                        <label>Notification Email</label>
                        <input type="email" id="notificationEmail" placeholder="Admin notification email">
                    </div>
                    <div class="form-group">
                        <label>Webhook Secret</label>
                        <input type="text" id="webhookSecret" placeholder="Webhook validation secret">
                    </div>
                </div>

                <div class="settings-section">
                    <h3>Lead Processing</h3>
                    <div class="form-group">
                        <label>Default Pipeline ID</label>
                        <input type="text" id="defaultPipelineId" placeholder="GoHighLevel Pipeline ID">
                    </div>
                </div>

                <button class="action-btn btn-primary" onclick="saveSystemSettings()">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal-overlay" id="editUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit User</h3>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <input type="hidden" id="editUserId">
                    <div class="form-row">
                        <div class="form-group">
                            <label>First Name</label>
                            <input type="text" id="editFirstName">
                        </div>
                        <div class="form-group">
                            <label>Last Name</label>
                            <input type="text" id="editLastName">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="editEmail">
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="editPhone">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Role</label>
                            <select id="editRole">
                                <option value="user">User</option>
                                <option value="buyer">Buyer</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="editStatus">
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Location ID</label>
                        <input type="text" id="editLocationId">
                    </div>
                    <div class="form-group">
                        <label>API Key</label>
                        <input type="text" id="editApiKey">
                    </div>
                    <div class="form-group">
                        <label>Agency Name</label>
                        <input type="text" id="editAgencyName">
                    </div>
                    <div class="form-group">
                        <label>Admin Notes</label>
                        <textarea id="editNotes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="close-btn" onclick="closeEditUserModal()">Cancel</button>
                <button class="save-btn" onclick="saveUserChanges()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Edit Order Modal -->
    <div class="modal-overlay" id="editOrderModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Order</h3>
            </div>
            <div class="modal-body">
                <form id="editOrderForm">
                    <input type="hidden" id="editOrderId">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Status</label>
                            <select id="editOrderStatus">
                                <option value="pending">Pending</option>
                                <option value="invoiced">Invoiced</option>
                                <option value="paid">Paid</option>
                                <option value="processing">Processing</option>
                                <option value="delivered">Delivered</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Assigned Admin</label>
                            <select id="editAssignedAdmin">
                                <option value="">Not Assigned</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Admin Notes</label>
                        <textarea id="editOrderNotes" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Processing Notes</label>
                        <textarea id="editProcessingNotes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="close-btn" onclick="closeEditOrderModal()">Cancel</button>
                <button class="save-btn" onclick="saveOrderChanges()">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://nsypkyubepyjhectnbtx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zeXBreXViZXB5amhlY3RuYnR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzODE5NDUsImV4cCI6MjA3Mzk1Nzk0NX0.m8V1EP4oUSC5qhjGMcbvbDMsg8EebLVR9YXpJkYmASA';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;

        // Initialize admin dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeAuth();
            await loadDashboardData();
        });

        async function initializeAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = 'index.html';
                return;
            }

            // Load user data and verify admin role
            const { data: userData, error } = await supabase
                .from('users')
                .select('*')
                .eq('id', session.user.id)
                .single();

            if (error || !userData || userData.role !== 'admin') {
                alert('Access denied. Admin privileges required.');
                window.location.href = 'index.html';
                return;
            }

            currentUser = userData;
            document.getElementById('adminEmail').textContent = currentUser.email;
        }

        async function loadDashboardData() {
            await loadOverviewStats();
            await loadRecentActivity();
            await loadOrdersTable();
            await loadUsersTable();
            await loadIntegrationsTable();
            await loadSettings();
        }

        function showAdminTab(tabName) {
            // Update nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + 'Tab').classList.add('active');

            // Load data for specific tabs
            switch(tabName) {
                case 'orders':
                    loadOrdersTable();
                    break;
                case 'users':
                    loadUsersTable();
                    break;
                case 'integrations':
                    // Load GoHighLevel data when integrations tab is clicked
                    loadGoHighLevelData();
                    loadIntegrationsTable();
                    break;
                case 'settings':
                    loadSettings();
                    break;
            }
        }

        async function loadOverviewStats() {
            try {
                // Load total orders
                const { count: totalOrders } = await supabase
                    .from('orders')
                    .select('*', { count: 'exact', head: true });

                // Load total users
                const { count: totalUsers } = await supabase
                    .from('users')
                    .select('*', { count: 'exact', head: true });

                // Load pending orders
                const { count: pendingOrders } = await supabase
                    .from('orders')
                    .select('*', { count: 'exact', head: true })
                    .eq('status', 'pending');

                // Calculate total revenue (approximate)
                const { data: orders } = await supabase
                    .from('orders')
                    .select('lead_quantity');

                const priceMap = { 50: 1500, 100: 3000, 200: 6000, 400: 12000 };
                const totalRevenue = orders?.reduce((sum, order) => {
                    return sum + (priceMap[order.lead_quantity] || 0);
                }, 0) || 0;

                document.getElementById('totalOrders').textContent = totalOrders || 0;
                document.getElementById('totalUsers').textContent = totalUsers || 0;
                document.getElementById('pendingOrders').textContent = pendingOrders || 0;
                document.getElementById('totalRevenue').textContent = '$' + totalRevenue.toLocaleString();

            } catch (error) {
                console.error('Error loading overview stats:', error);
            }
        }

        async function loadRecentActivity() {
            try {
                const { data: activity, error } = await supabase
                    .from('admin_activity_log')
                    .select(`
                        *,
                        admin:admin_id(first_name, last_name, email)
                    `)
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (error) throw error;

                const tbody = document.getElementById('recentActivity');
                if (!activity || activity.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #7f8c8d;">No recent activity</td></tr>';
                    return;
                }

                tbody.innerHTML = activity.map(item => `
                    <tr>
                        <td>${new Date(item.created_at).toLocaleDateString()}</td>
                        <td>${item.target_type || 'System'}</td>
                        <td>${item.admin?.first_name ? `${item.admin.first_name} ${item.admin.last_name}` : item.admin?.email || 'System'}</td>
                        <td>${item.action}</td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${JSON.stringify(item.details || {})}</td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error('Error loading recent activity:', error);
                document.getElementById('recentActivity').innerHTML =
                    '<tr><td colspan="5" style="text-align: center; color: #e74c3c;">Error loading activity</td></tr>';
            }
        }

        async function loadOrdersTable() {
            try {
                const { data: orders, error } = await supabase
                    .from('orders')
                    .select(`
                        *,
                        user:user_id(first_name, last_name, email),
                        assigned_admin_user:assigned_admin(first_name, last_name, email)
                    `)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const tbody = document.getElementById('ordersTable');
                if (!orders || orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #7f8c8d;">No orders found</td></tr>';
                    return;
                }

                const priceMap = { 50: 1500, 100: 3000, 200: 6000, 400: 12000 };

                tbody.innerHTML = orders.map(order => `
                    <tr>
                        <td>#${order.id.substring(0, 8)}</td>
                        <td>${order.user?.first_name ? `${order.user.first_name} ${order.user.last_name}` : order.user?.email || 'Unknown'}</td>
                        <td>${order.order_type === 'individual' ? 'Individual' : 'Agency'}</td>
                        <td>${order.lead_quantity} leads</td>
                        <td>$${(priceMap[order.lead_quantity] || 0).toLocaleString()}</td>
                        <td><span class="status-badge status-${order.status}">${order.status}</span></td>
                        <td>${new Date(order.created_at).toLocaleDateString()}</td>
                        <td>
                            <button class="action-btn btn-primary" onclick="editOrder('${order.id}')">Edit</button>
                            <button class="action-btn btn-success" onclick="markOrderComplete('${order.id}')">Complete</button>
                        </td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error('Error loading orders:', error);
                document.getElementById('ordersTable').innerHTML =
                    '<tr><td colspan="8" style="text-align: center; color: #e74c3c;">Error loading orders</td></tr>';
            }
        }

        async function loadUsersTable() {
            try {
                const { data: users, error } = await supabase
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const tbody = document.getElementById('usersTable');
                if (!users || users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #7f8c8d;">No users found</td></tr>';
                    return;
                }

                tbody.innerHTML = users.map(user => `
                    <tr>
                        <td>${user.first_name && user.last_name ? `${user.first_name} ${user.last_name}` : 'Not provided'}</td>
                        <td>${user.email}</td>
                        <td><span class="role-badge role-${user.role}">${user.role}</span></td>
                        <td style="font-family: monospace; font-size: 12px;">${user.location_id}</td>
                        <td>${user.is_active !== false ? 'Active' : 'Inactive'}</td>
                        <td>${new Date(user.created_at).toLocaleDateString()}</td>
                        <td>
                            <button class="action-btn btn-primary" onclick="editUser('${user.id}')">Edit</button>
                            <button class="action-btn ${user.is_active !== false ? 'btn-warning' : 'btn-success'}"
                                    onclick="toggleUserStatus('${user.id}', ${user.is_active !== false})">
                                ${user.is_active !== false ? 'Deactivate' : 'Activate'}
                            </button>
                        </td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('usersTable').innerHTML =
                    '<tr><td colspan="7" style="text-align: center; color: #e74c3c;">Error loading users</td></tr>';
            }
        }

        async function loadIntegrationsTable() {
            try {
                const { data: integrations, error } = await supabase
                    .from('ghl_integrations')
                    .select('*')
                    .order('created_at', { ascending: false });

                const tbody = document.getElementById('integrationsTable');

                if (error) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #e74c3c;">Error loading integrations</td></tr>';
                    return;
                }

                if (!integrations || integrations.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #7f8c8d;">No integrations configured</td></tr>';
                    return;
                }

                tbody.innerHTML = integrations.map(integration => `
                    <tr>
                        <td style="font-family: monospace; font-size: 12px;">${integration.location_id}</td>
                        <td>${integration.location_name || 'Unknown'}</td>
                        <td><span class="status-badge ${integration.is_active ? 'status-completed' : 'status-pending'}">${integration.is_active ? 'Active' : 'Inactive'}</span></td>
                        <td>${new Date(integration.created_at).toLocaleDateString()}</td>
                        <td>
                            <button class="action-btn btn-primary" onclick="testIntegration('${integration.id}')">Test</button>
                            <button class="action-btn ${integration.is_active ? 'btn-warning' : 'btn-success'}"
                                    onclick="toggleIntegration('${integration.id}', ${integration.is_active})">
                                ${integration.is_active ? 'Disable' : 'Enable'}
                            </button>
                            <button class="action-btn btn-danger" onclick="deleteIntegration('${integration.id}')">Delete</button>
                        </td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error('Error loading integrations:', error);
                document.getElementById('integrationsTable').innerHTML =
                    '<tr><td colspan="5" style="text-align: center; color: #e74c3c;">Error loading integrations</td></tr>';
            }
        }

        async function loadSettings() {
            try {
                const { data: settings, error } = await supabase
                    .from('admin_settings')
                    .select('*');

                if (error) throw error;

                const settingsMap = {};
                settings?.forEach(setting => {
                    settingsMap[setting.setting_key] = setting.setting_value;
                });

                // Populate form fields
                document.getElementById('ghlPrivateToken').value = settingsMap.ghl_private_token || '';
                document.getElementById('ghlLocationId').value = settingsMap.ghl_location_id || '';
                document.getElementById('notificationEmail').value = settingsMap.notification_email || '';
                document.getElementById('webhookSecret').value = settingsMap.webhook_secret || '';
                document.getElementById('defaultPipelineId').value = settingsMap.default_pipeline_id || '';

                // Populate workflow settings
                document.getElementById('createUpdateContact').checked = settingsMap.workflow_create_contact !== 'false'; // Default true
                document.getElementById('addToPipeline').checked = settingsMap.workflow_add_pipeline === 'true';
                document.getElementById('addTags').checked = settingsMap.workflow_add_tags === 'true';

                // Field mappings
                if (settingsMap.workflow_name_field) document.getElementById('nameFieldMapping').value = settingsMap.workflow_name_field;
                if (settingsMap.workflow_email_field) document.getElementById('emailFieldMapping').value = settingsMap.workflow_email_field;
                if (settingsMap.workflow_phone_field) document.getElementById('phoneFieldMapping').value = settingsMap.workflow_phone_field;
                if (settingsMap.workflow_order_value_field) document.getElementById('orderValueFieldMapping').value = settingsMap.workflow_order_value_field;

                // Pipeline settings
                if (settingsMap.workflow_pipeline_id) document.getElementById('pipelineSelect').value = settingsMap.workflow_pipeline_id;
                if (settingsMap.workflow_stage_id) document.getElementById('stageSelect').value = settingsMap.workflow_stage_id;

                // Load saved tags
                if (settingsMap.workflow_tags) {
                    try {
                        selectedWorkflowTags = JSON.parse(settingsMap.workflow_tags) || [];
                        updateSelectedTagsDisplay();
                    } catch (e) {
                        selectedWorkflowTags = [];
                    }
                }

                // Auto-load GoHighLevel data if token and location ID are available
                const hasCredentials = settingsMap.ghl_private_token && settingsMap.ghl_location_id;
                if (hasCredentials) {
                    setTimeout(() => {
                        loadGoHighLevelData();
                    }, 500); // Small delay to ensure UI is ready
                }

            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // Private Integration Functions
        async function savePrivateIntegration() {
            try {
                const privateToken = document.getElementById('ghlPrivateToken').value;
                const locationId = document.getElementById('ghlLocationId').value;

                if (!privateToken || !locationId) {
                    showPrivateTokenResult('Please enter both Private Integration Token and Location ID', 'error');
                    return;
                }

                if (!privateToken.startsWith('pit-')) {
                    showPrivateTokenResult('Private integration tokens should start with "pit-"', 'error');
                    return;
                }

                const updates = [
                    { setting_key: 'ghl_private_token', setting_value: privateToken },
                    { setting_key: 'ghl_location_id', setting_value: locationId }
                ];

                for (const update of updates) {
                    await supabase
                        .from('admin_settings')
                        .upsert(update);
                }

                await logAdminActivity('private_integration_saved', 'settings', null, {
                    token_length: privateToken.length,
                    location_id: locationId,
                    token_prefix: privateToken.substring(0, 8) + '...'
                });

                showPrivateTokenResult('Private integration saved successfully', 'success');

            } catch (error) {
                console.error('Error saving private integration:', error);
                showPrivateTokenResult('Error saving integration: ' + error.message, 'error');
            }
        }

        async function findLocationId() {
            try {
                const privateToken = document.getElementById('ghlPrivateToken').value;

                if (!privateToken) {
                    showPrivateTokenResult('Please enter your Private Integration Token first', 'error');
                    return;
                }

                showPrivateTokenResult('🔍 Finding your GoHighLevel locations...', 'info');

                const response = await fetch('/api/ghl/get-locations.js', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        privateToken
                    })
                });

                const data = await response.json();

                if (data.success && data.locations && data.locations.length > 0) {
                    let resultMessage = `✅ Found ${data.locations.length} location(s):\n\n`;
                    data.locations.forEach((location, index) => {
                        resultMessage += `${index + 1}. ${location.name || location.businessName || 'Unnamed Location'}\n`;
                        resultMessage += `   Location ID: ${location.id}\n`;
                        if (location.city && location.state) {
                            resultMessage += `   Address: ${location.city}, ${location.state}\n`;
                        }
                        resultMessage += '\n';
                    });

                    // Auto-fill the first location if only one is found
                    if (data.locations.length === 1) {
                        document.getElementById('ghlLocationId').value = data.locations[0].id;
                        resultMessage += `✨ Auto-filled Location ID: ${data.locations[0].id}`;
                    } else {
                        resultMessage += 'Copy the Location ID you want to use and paste it in the Location ID field above.';
                    }

                    showPrivateTokenResult(resultMessage, 'success');
                } else {
                    showPrivateTokenResult(`❌ ${data.message || 'No locations found'}`, 'error');
                }

            } catch (error) {
                console.error('Find Location ID error:', error);
                showPrivateTokenResult(`❌ Failed to find locations: ${error.message}`, 'error');
            }
        }

        async function testContactsAPI() {
            try {
                const privateToken = document.getElementById('ghlPrivateToken').value;
                const locationId = document.getElementById('ghlLocationId').value;

                if (!privateToken || !locationId) {
                    showPrivateTokenResult('Please enter both Private Integration Token and Location ID first', 'error');
                    return;
                }

                showPrivateTokenResult('Testing Contacts API...', 'info');

                // Test the Contacts API via Vercel API route
                const response = await fetch('/api/ghl/test-contacts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        privateToken,
                        locationId
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showPrivateTokenResult(`${data.message}\n\nScopes confirmed: ${data.data.scopes.join(', ')}\n\nAPI Endpoint: ${data.data.endpoint}\nLocation ID: ${locationId}`, 'success');

                    await logAdminActivity('contacts_api_test_success', 'settings', null, {
                        contacts_found: data.data.contactCount,
                        location_id: locationId,
                        response_status: response.status
                    });

                } else {
                    showPrivateTokenResult(`${data.message}\n\nPlease check your token, location ID, and permissions.`, 'error');

                    await logAdminActivity('contacts_api_test_failed', 'settings', null, {
                        response_status: response.status,
                        location_id: locationId,
                        error: data.error
                    });
                }

            } catch (error) {
                console.error('Error testing contacts API:', error);
                showPrivateTokenResult(`❌ Contacts API Test Failed!\n\nError: ${error.message}\n\nThis could be due to CORS restrictions. The token may still work server-side.`, 'error');
            }
        }

        async function testOpportunitiesAPI() {
            try {
                const privateToken = document.getElementById('ghlPrivateToken').value;
                const locationId = document.getElementById('ghlLocationId').value;

                if (!privateToken || !locationId) {
                    showPrivateTokenResult('Please enter both Private Integration Token and Location ID first', 'error');
                    return;
                }

                showPrivateTokenResult('Testing Opportunities API...', 'info');

                // Test the Opportunities API via Vercel API route
                const response = await fetch('/api/ghl/test-opportunities', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        privateToken,
                        locationId
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showPrivateTokenResult(`${data.message}\n\nScopes confirmed: ${data.data.scopes.join(', ')}\n\nAPI Endpoint: ${data.data.endpoint}\nLocation ID: ${locationId}`, 'success');

                    await logAdminActivity('opportunities_api_test_success', 'settings', null, {
                        opportunities_found: data.data.opportunityCount,
                        location_id: locationId,
                        response_status: response.status
                    });

                } else {
                    showPrivateTokenResult(`${data.message}\n\nPlease check your token, location ID, and permissions.`, 'error');

                    await logAdminActivity('opportunities_api_test_failed', 'settings', null, {
                        response_status: response.status,
                        location_id: locationId,
                        error: data.error
                    });
                }

            } catch (error) {
                console.error('Error testing opportunities API:', error);
                showPrivateTokenResult(`❌ Opportunities API Test Failed!\n\nError: ${error.message}\n\nThis could be due to CORS restrictions. The token may still work server-side.`, 'error');
            }
        }

        async function testTagsAPI() {
            try {
                const privateToken = document.getElementById('ghlPrivateToken').value;
                const locationId = document.getElementById('ghlLocationId').value;

                if (!privateToken || !locationId) {
                    showPrivateTokenResult('Please enter both Private Integration Token and Location ID first', 'error');
                    return;
                }

                showPrivateTokenResult('Testing Tags API...', 'info');

                // Test the Tags API via Vercel API route
                const response = await fetch('/api/ghl/test-tags', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        privateToken,
                        locationId
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showPrivateTokenResult(`${data.message}\n\nScopes confirmed: ${data.data.scopes.join(', ')}\n\nAPI Endpoint: ${data.data.endpoint}\nLocation ID: ${locationId}`, 'success');

                    await logAdminActivity('tags_api_test_success', 'settings', null, {
                        tags_found: data.data.tagCount,
                        location_id: locationId,
                        response_status: response.status
                    });

                } else {
                    showPrivateTokenResult(`${data.message}\n\nPlease check your token, location ID, and permissions.`, 'error');

                    await logAdminActivity('tags_api_test_failed', 'settings', null, {
                        response_status: response.status,
                        location_id: locationId,
                        error: data.error
                    });
                }

            } catch (error) {
                console.error('Error testing tags API:', error);
                showPrivateTokenResult(`❌ Tags API Test Failed!\n\nError: ${error.message}\n\nThis could be due to CORS restrictions. The token may still work server-side.`, 'error');
            }
        }

        function showPrivateTokenResult(message, type) {
            const resultDiv = document.getElementById('privateTokenResult');
            resultDiv.style.display = 'block';
            resultDiv.style.whiteSpace = 'pre-line';

            switch(type) {
                case 'success':
                    resultDiv.style.backgroundColor = '#d4edda';
                    resultDiv.style.borderColor = '#c3e6cb';
                    resultDiv.style.color = '#155724';
                    break;
                case 'error':
                    resultDiv.style.backgroundColor = '#f8d7da';
                    resultDiv.style.borderColor = '#f5c6cb';
                    resultDiv.style.color = '#721c24';
                    break;
                case 'info':
                    resultDiv.style.backgroundColor = '#cce5ff';
                    resultDiv.style.borderColor = '#b8daff';
                    resultDiv.style.color = '#004085';
                    break;
            }

            resultDiv.style.border = '1px solid';
            resultDiv.textContent = message;

            if (type !== 'error') {
                setTimeout(() => {
                    resultDiv.style.display = 'none';
                }, 15000);
            }
        }

        async function logout() {
            await supabase.auth.signOut();
            window.location.href = 'index.html';
        }

        // User Management Functions
        async function editUser(userId) {
            try {
                const { data: user, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', userId)
                    .single();

                if (error) throw error;

                // Populate form
                document.getElementById('editUserId').value = user.id;
                document.getElementById('editFirstName').value = user.first_name || '';
                document.getElementById('editLastName').value = user.last_name || '';
                document.getElementById('editEmail').value = user.email || '';
                document.getElementById('editPhone').value = user.phone || '';
                document.getElementById('editRole').value = user.role || 'user';
                document.getElementById('editStatus').value = user.is_active !== false ? 'true' : 'false';
                document.getElementById('editLocationId').value = user.location_id || '';
                document.getElementById('editApiKey').value = user.api_key || '';
                document.getElementById('editAgencyName').value = user.agency_name || '';
                document.getElementById('editNotes').value = user.notes || '';

                document.getElementById('editUserModal').classList.add('show');
                document.body.style.overflow = 'hidden';

            } catch (error) {
                console.error('Error loading user:', error);
                alert('Error loading user details');
            }
        }

        async function saveUserChanges() {
            try {
                const userId = document.getElementById('editUserId').value;
                const updateData = {
                    first_name: document.getElementById('editFirstName').value,
                    last_name: document.getElementById('editLastName').value,
                    email: document.getElementById('editEmail').value,
                    phone: document.getElementById('editPhone').value,
                    role: document.getElementById('editRole').value,
                    is_active: document.getElementById('editStatus').value === 'true',
                    location_id: document.getElementById('editLocationId').value,
                    api_key: document.getElementById('editApiKey').value,
                    agency_name: document.getElementById('editAgencyName').value,
                    notes: document.getElementById('editNotes').value
                };

                const { error } = await supabase
                    .from('users')
                    .update(updateData)
                    .eq('id', userId);

                if (error) throw error;

                // Log admin activity
                await logAdminActivity('user_update', 'user', userId, updateData);

                closeEditUserModal();
                await loadUsersTable();
                alert('User updated successfully');

            } catch (error) {
                console.error('Error updating user:', error);
                alert('Error updating user: ' + error.message);
            }
        }

        async function toggleUserStatus(userId, currentStatus) {
            try {
                const newStatus = !currentStatus;
                const { error } = await supabase
                    .from('users')
                    .update({ is_active: newStatus })
                    .eq('id', userId);

                if (error) throw error;

                await logAdminActivity('user_status_toggle', 'user', userId, {
                    old_status: currentStatus,
                    new_status: newStatus
                });

                await loadUsersTable();
                alert(`User ${newStatus ? 'activated' : 'deactivated'} successfully`);

            } catch (error) {
                console.error('Error toggling user status:', error);
                alert('Error updating user status');
            }
        }

        // Order Management Functions
        async function editOrder(orderId) {
            try {
                const { data: order, error } = await supabase
                    .from('orders')
                    .select('*')
                    .eq('id', orderId)
                    .single();

                if (error) throw error;

                // Load admin users for assignment dropdown
                const { data: admins } = await supabase
                    .from('users')
                    .select('id, first_name, last_name, email')
                    .eq('role', 'admin');

                const adminSelect = document.getElementById('editAssignedAdmin');
                adminSelect.innerHTML = '<option value="">Not Assigned</option>' +
                    (admins || []).map(admin =>
                        `<option value="${admin.id}" ${order.assigned_admin === admin.id ? 'selected' : ''}>
                            ${admin.first_name && admin.last_name ? `${admin.first_name} ${admin.last_name}` : admin.email}
                        </option>`
                    ).join('');

                // Populate form
                document.getElementById('editOrderId').value = order.id;
                document.getElementById('editOrderStatus').value = order.status;
                document.getElementById('editOrderNotes').value = order.admin_notes || '';
                document.getElementById('editProcessingNotes').value = order.processing_notes || '';

                document.getElementById('editOrderModal').classList.add('show');
                document.body.style.overflow = 'hidden';

            } catch (error) {
                console.error('Error loading order:', error);
                alert('Error loading order details');
            }
        }

        async function saveOrderChanges() {
            try {
                const orderId = document.getElementById('editOrderId').value;
                const oldStatus = document.getElementById('editOrderStatus').dataset.oldValue;
                const newStatus = document.getElementById('editOrderStatus').value;

                const updateData = {
                    status: newStatus,
                    assigned_admin: document.getElementById('editAssignedAdmin').value || null,
                    admin_notes: document.getElementById('editOrderNotes').value,
                    processing_notes: document.getElementById('editProcessingNotes').value
                };

                const { error } = await supabase
                    .from('orders')
                    .update(updateData)
                    .eq('id', orderId);

                if (error) throw error;

                // Log status change if status changed
                if (oldStatus && oldStatus !== newStatus) {
                    await supabase
                        .from('order_status_history')
                        .insert({
                            order_id: orderId,
                            old_status: oldStatus,
                            new_status: newStatus,
                            changed_by: currentUser.id,
                            change_reason: 'Admin update'
                        });
                }

                await logAdminActivity('order_update', 'order', orderId, updateData);

                closeEditOrderModal();
                await loadOrdersTable();
                await loadOverviewStats();
                alert('Order updated successfully');

            } catch (error) {
                console.error('Error updating order:', error);
                alert('Error updating order: ' + error.message);
            }
        }

        async function markOrderComplete(orderId) {
            if (!confirm('Mark this order as completed?')) return;

            try {
                const { error } = await supabase
                    .from('orders')
                    .update({ status: 'completed' })
                    .eq('id', orderId);

                if (error) throw error;

                await logAdminActivity('order_complete', 'order', orderId, { status: 'completed' });

                await loadOrdersTable();
                await loadOverviewStats();
                alert('Order marked as completed');

            } catch (error) {
                console.error('Error completing order:', error);
                alert('Error updating order status');
            }
        }

        // Settings Functions

        async function saveSystemSettings() {
            try {
                const updates = [
                    { setting_key: 'notification_email', setting_value: document.getElementById('notificationEmail').value },
                    { setting_key: 'webhook_secret', setting_value: document.getElementById('webhookSecret').value },
                    { setting_key: 'default_pipeline_id', setting_value: document.getElementById('defaultPipelineId').value }
                ];

                for (const update of updates) {
                    await supabase
                        .from('admin_settings')
                        .upsert(update);
                }

                await logAdminActivity('system_settings_update', 'settings', null, updates);

                alert('System settings saved successfully');

            } catch (error) {
                console.error('Error saving system settings:', error);
                alert('Error saving settings: ' + error.message);
            }
        }

        // Global variables for workflow data
        let availableCustomFields = [];
        let availablePipelines = [];
        let availableTags = [];
        let selectedWorkflowTags = [];

        // Workflow Settings Functions
        async function saveWorkflowSettings() {
            try {
                const createUpdateContact = document.getElementById('createUpdateContact').checked;
                const addToPipeline = document.getElementById('addToPipeline').checked;
                const addTags = document.getElementById('addTags').checked;

                const nameFieldMapping = document.getElementById('nameFieldMapping').value;
                const emailFieldMapping = document.getElementById('emailFieldMapping').value;
                const phoneFieldMapping = document.getElementById('phoneFieldMapping').value;
                const orderValueFieldMapping = document.getElementById('orderValueFieldMapping').value;

                const pipelineId = document.getElementById('pipelineSelect').value;
                const stageId = document.getElementById('stageSelect').value;

                const updates = [
                    { setting_key: 'workflow_enabled', setting_value: 'true' }, // Always enabled
                    { setting_key: 'workflow_create_contact', setting_value: createUpdateContact.toString() },
                    { setting_key: 'workflow_add_pipeline', setting_value: addToPipeline.toString() },
                    { setting_key: 'workflow_add_tags', setting_value: addTags.toString() },
                    { setting_key: 'workflow_pipeline_id', setting_value: pipelineId },
                    { setting_key: 'workflow_stage_id', setting_value: stageId },
                    { setting_key: 'workflow_tags', setting_value: JSON.stringify(selectedWorkflowTags) },
                    { setting_key: 'workflow_name_field', setting_value: nameFieldMapping },
                    { setting_key: 'workflow_email_field', setting_value: emailFieldMapping },
                    { setting_key: 'workflow_phone_field', setting_value: phoneFieldMapping },
                    { setting_key: 'workflow_order_value_field', setting_value: orderValueFieldMapping }
                ];

                for (const update of updates) {
                    await supabase
                        .from('admin_settings')
                        .upsert(update);
                }

                await logAdminActivity('workflow_settings_update', 'settings', null, {
                    actions: {
                        create_contact: createUpdateContact,
                        add_pipeline: addToPipeline,
                        add_tags: addTags
                    },
                    mappings: {
                        name_field: nameFieldMapping,
                        email_field: emailFieldMapping,
                        phone_field: phoneFieldMapping,
                        order_value_field: orderValueFieldMapping
                    },
                    pipeline_id: pipelineId,
                    stage_id: stageId,
                    tags_count: selectedWorkflowTags.length
                });

                showWorkflowResult('✅ Workflow settings saved successfully!', 'success');

            } catch (error) {
                console.error('Error saving workflow settings:', error);
                showWorkflowResult('❌ Error saving workflow settings: ' + error.message, 'error');
            }
        }

        async function testWorkflow() {
            try {
                const privateToken = document.getElementById('ghlPrivateToken').value;
                const locationId = document.getElementById('ghlLocationId').value;

                if (!privateToken || !locationId) {
                    showWorkflowResult('❌ Please configure Private Integration Token and Location ID first', 'error');
                    return;
                }

                showWorkflowResult('🧪 Testing workflow with sample order data...', 'info');

                // Test data
                const testOrderData = {
                    customerEmail: 'test@example.com',
                    customerName: 'Test Customer',
                    customerPhone: '+1234567890',
                    orderTotal: 99.99,
                    orderId: 'TEST-' + Date.now()
                };

                // Check which actions are enabled
                const actions = [];
                if (document.getElementById('createUpdateContact').checked) {
                    actions.push(`✓ Create/Update Contact (${testOrderData.customerName})`);
                }
                if (document.getElementById('addToPipeline').checked) {
                    const pipelineName = document.getElementById('pipelineSelect').selectedOptions[0]?.text || 'Selected Pipeline';
                    const stageName = document.getElementById('stageSelect').selectedOptions[0]?.text || 'Selected Stage';
                    actions.push(`✓ Add to Pipeline: ${pipelineName} → ${stageName}`);
                }
                if (document.getElementById('addTags').checked && selectedWorkflowTags.length > 0) {
                    actions.push(`✓ Add Tags: ${selectedWorkflowTags.map(tag => tag.name).join(', ')}`);
                }

                if (actions.length === 0) {
                    showWorkflowResult('⚠️ No workflow actions are enabled. Please enable at least one action.', 'error');
                    return;
                }

                // Simulate success
                setTimeout(() => {
                    showWorkflowResult(`✅ Workflow Test Successful!

Test Order: ${testOrderData.orderId}
Customer: ${testOrderData.customerName} (${testOrderData.customerEmail})
Total: $${testOrderData.orderTotal}

Actions that would be performed:
${actions.join('\n')}

Field Mappings:
• Name → ${document.getElementById('nameFieldMapping').selectedOptions[0]?.text || 'Not mapped'}
• Email → ${document.getElementById('emailFieldMapping').selectedOptions[0]?.text || 'Not mapped'}
• Phone → ${document.getElementById('phoneFieldMapping').selectedOptions[0]?.text || 'Not mapped'}
• Order Value → ${document.getElementById('orderValueFieldMapping').selectedOptions[0]?.text || 'Not mapped'}

Note: This is a simulation. Real orders will trigger actual GoHighLevel API calls.`, 'success');
                }, 2000);

            } catch (error) {
                console.error('Error testing workflow:', error);
                showWorkflowResult('❌ Error testing workflow: ' + error.message, 'error');
            }
        }

        // Auto-load all GoHighLevel data
        async function loadGoHighLevelData() {
            try {
                showWorkflowResult('Loading GoHighLevel data...', 'info');

                // Load all data in parallel for better performance
                await Promise.all([
                    loadCustomFields(),
                    loadPipelines(),
                    loadTags()
                ]);

                showWorkflowResult('✅ GoHighLevel data loaded successfully!', 'success');
            } catch (error) {
                console.error('Error loading GoHighLevel data:', error);
                showWorkflowResult('❌ Error loading GoHighLevel data: ' + error.message, 'error');
            }
        }

        // Load GoHighLevel Data Functions
        async function loadCustomFields() {
            try {
                const privateToken = document.getElementById('ghlPrivateToken').value;
                const locationId = document.getElementById('ghlLocationId').value;

                if (!privateToken || !locationId) {
                    return; // Silently fail if no credentials
                }

                const response = await fetch('/api/ghl/get-custom-fields', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        privateToken,
                        locationId
                    })
                });

                const data = await response.json();

                console.log('Custom fields response received:', data);

                if (data.success) {
                    availableCustomFields = data.customFields || [];

                    console.log('Available custom fields:', availableCustomFields);

                    // Standard contact fields
                    const standardFields = [
                        { id: 'firstName', name: 'First Name' },
                        { id: 'lastName', name: 'Last Name' },
                        { id: 'name', name: 'Full Name' },
                        { id: 'email', name: 'Email' },
                        { id: 'phone', name: 'Phone' }
                    ];

                    const allFields = [...standardFields, ...availableCustomFields];

                    console.log('All fields for dropdowns:', allFields);

                    // Populate dropdowns
                    populateFieldDropdown('nameFieldMapping', allFields, 'name');
                    populateFieldDropdown('emailFieldMapping', allFields, 'email');
                    populateFieldDropdown('phoneFieldMapping', allFields, 'phone');
                    populateFieldDropdown('orderValueFieldMapping', allFields);

                    console.log(`✅ Loaded ${availableCustomFields.length} custom fields + ${standardFields.length} standard fields`);
                } else {
                    console.error('Custom Fields API Error:', data.message, data.debug);
                    throw new Error(data.message);
                }

            } catch (error) {
                console.error('Error loading custom fields:', error);
                throw error; // Re-throw for parent function to handle
            }
        }

        function populateFieldDropdown(selectId, fields, defaultValue = '') {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">Select GoHighLevel field...</option>';

            fields.forEach(field => {
                const option = document.createElement('option');
                option.value = field.id;
                option.textContent = field.name;
                if (field.id === defaultValue) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        async function loadPipelines() {
            try {
                const privateToken = document.getElementById('ghlPrivateToken').value;
                const locationId = document.getElementById('ghlLocationId').value;

                if (!privateToken || !locationId) {
                    return; // Silently fail if no credentials
                }

                const response = await fetch('/api/ghl/get-pipelines', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        privateToken,
                        locationId
                    })
                });

                const data = await response.json();

                if (data.success) {
                    availablePipelines = data.pipelines || [];

                    const select = document.getElementById('pipelineSelect');
                    select.innerHTML = '<option value="">Select pipeline...</option>';

                    availablePipelines.forEach(pipeline => {
                        const option = document.createElement('option');
                        option.value = pipeline.id;
                        option.textContent = pipeline.name;
                        select.appendChild(option);
                    });

                    console.log(`✅ Loaded ${availablePipelines.length} pipelines`);
                } else {
                    console.error('Pipelines API Error:', data.message, data.debug);
                    throw new Error(data.message);
                }

            } catch (error) {
                console.error('Error loading pipelines:', error);
                throw error; // Re-throw for parent function to handle
            }
        }

        function loadPipelineStages() {
            const pipelineSelect = document.getElementById('pipelineSelect');
            const stageSelect = document.getElementById('stageSelect');
            const selectedPipelineId = pipelineSelect.value;

            if (!selectedPipelineId) {
                stageSelect.innerHTML = '<option value="">Select pipeline first...</option>';
                stageSelect.disabled = true;
                return;
            }

            const pipeline = availablePipelines.find(p => p.id === selectedPipelineId);

            if (pipeline && pipeline.stages) {
                stageSelect.innerHTML = '<option value="">Select stage...</option>';
                pipeline.stages.forEach(stage => {
                    const option = document.createElement('option');
                    option.value = stage.id;
                    option.textContent = stage.name;
                    stageSelect.appendChild(option);
                });
                stageSelect.disabled = false;
            } else {
                stageSelect.innerHTML = '<option value="">No stages found</option>';
                stageSelect.disabled = true;
            }
        }

        async function loadTags() {
            try {
                const privateToken = document.getElementById('ghlPrivateToken').value;
                const locationId = document.getElementById('ghlLocationId').value;

                if (!privateToken || !locationId) {
                    return; // Silently fail if no credentials
                }

                const response = await fetch('/api/ghl/get-tags', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        privateToken,
                        locationId
                    })
                });

                const data = await response.json();

                if (data.success) {
                    availableTags = data.tags || [];
                    console.log(`✅ Loaded ${availableTags.length} tags`);
                } else {
                    console.error('Tags API Error:', data.message, data.debug);
                    throw new Error(data.message);
                }

            } catch (error) {
                console.error('Error loading tags:', error);
                throw error; // Re-throw for parent function to handle
            }
        }

        // Tag Management Functions
        function searchTags() {
            const input = document.getElementById('tagSearchInput');
            const dropdown = document.getElementById('tagDropdown');
            const searchTerm = input.value.toLowerCase();

            if (searchTerm.length === 0) {
                dropdown.style.display = 'none';
                return;
            }

            const filteredTags = availableTags.filter(tag =>
                tag.name.toLowerCase().includes(searchTerm) &&
                !selectedWorkflowTags.some(selected => selected.id === tag.id)
            );

            let dropdownContent = '';

            // Show existing tags
            filteredTags.forEach(tag => {
                dropdownContent += `<div style="padding: 8px; cursor: pointer; border-bottom: 1px solid #eee;" onclick="selectTag('${tag.id}', '${tag.name}')">
                    ${tag.name}
                </div>`;
            });

            // Show create option if no exact match
            const exactMatch = availableTags.some(tag => tag.name.toLowerCase() === searchTerm);
            if (!exactMatch && searchTerm.trim()) {
                dropdownContent += `<div style="padding: 8px; cursor: pointer; background: #f8f9fa; color: #007bff; border-bottom: 1px solid #eee;" onclick="createAndSelectTag('${searchTerm.trim()}')">
                    + Create "${searchTerm.trim()}"
                </div>`;
            }

            dropdown.innerHTML = dropdownContent;
            dropdown.style.display = dropdownContent ? 'block' : 'none';
        }

        function showTagDropdown() {
            const dropdown = document.getElementById('tagDropdown');
            let dropdownContent = '';

            availableTags.forEach(tag => {
                if (!selectedWorkflowTags.some(selected => selected.id === tag.id)) {
                    dropdownContent += `<div style="padding: 8px; cursor: pointer; border-bottom: 1px solid #eee;" onclick="selectTag('${tag.id}', '${tag.name}')">
                        ${tag.name}
                    </div>`;
                }
            });

            dropdown.innerHTML = dropdownContent;
            dropdown.style.display = dropdownContent ? 'block' : 'none';
        }

        function selectTag(tagId, tagName) {
            if (!selectedWorkflowTags.some(tag => tag.id === tagId)) {
                selectedWorkflowTags.push({ id: tagId, name: tagName });
                updateSelectedTagsDisplay();
            }
            document.getElementById('tagSearchInput').value = '';
            document.getElementById('tagDropdown').style.display = 'none';
        }

        async function createAndSelectTag(tagName) {
            try {
                const privateToken = document.getElementById('ghlPrivateToken').value;
                const locationId = document.getElementById('ghlLocationId').value;

                showWorkflowResult(`Creating tag "${tagName}"...`, 'info');

                const response = await fetch('/api/ghl/create-tag', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        privateToken,
                        locationId,
                        tagName
                    })
                });

                const data = await response.json();

                if (data.success) {
                    const newTag = { id: data.tag.id, name: tagName };
                    availableTags.push(newTag);
                    selectedWorkflowTags.push(newTag);
                    updateSelectedTagsDisplay();
                    showWorkflowResult(`✅ Tag "${tagName}" created and selected`, 'success');
                } else {
                    showWorkflowResult(data.message, 'error');
                }

                document.getElementById('tagSearchInput').value = '';
                document.getElementById('tagDropdown').style.display = 'none';

            } catch (error) {
                console.error('Error creating tag:', error);
                showWorkflowResult('❌ Error creating tag: ' + error.message, 'error');
            }
        }

        function updateSelectedTagsDisplay() {
            const container = document.getElementById('selectedTags');
            container.innerHTML = '';

            selectedWorkflowTags.forEach(tag => {
                const tagElement = document.createElement('span');
                tagElement.style.cssText = 'background: #007bff; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; display: flex; align-items: center; gap: 4px;';
                tagElement.innerHTML = `
                    ${tag.name}
                    <span onclick="removeTag('${tag.id}')" style="cursor: pointer; font-weight: bold;">&times;</span>
                `;
                container.appendChild(tagElement);
            });
        }

        function removeTag(tagId) {
            selectedWorkflowTags = selectedWorkflowTags.filter(tag => tag.id !== tagId);
            updateSelectedTagsDisplay();
        }

        // Hide dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const tagInput = document.getElementById('tagSearchInput');
            const tagDropdown = document.getElementById('tagDropdown');

            if (tagInput && tagDropdown && !tagInput.contains(event.target) && !tagDropdown.contains(event.target)) {
                tagDropdown.style.display = 'none';
            }
        });

        function showWorkflowResult(message, type) {
            const resultDiv = document.getElementById('workflowResult');
            resultDiv.style.display = 'block';
            resultDiv.textContent = message;
            resultDiv.className = '';

            if (type === 'success') {
                resultDiv.style.backgroundColor = '#d4edda';
                resultDiv.style.color = '#155724';
                resultDiv.style.borderLeft = '4px solid #28a745';
            } else if (type === 'error') {
                resultDiv.style.backgroundColor = '#f8d7da';
                resultDiv.style.color = '#721c24';
                resultDiv.style.borderLeft = '4px solid #dc3545';
            } else if (type === 'info') {
                resultDiv.style.backgroundColor = '#cce7ff';
                resultDiv.style.color = '#004085';
                resultDiv.style.borderLeft = '4px solid #007bff';
            }

            // Auto-hide after 10 seconds for success/info messages
            if (type !== 'error') {
                setTimeout(() => {
                    resultDiv.style.display = 'none';
                }, 10000);
            }
        }

        // Integration Functions
        async function testIntegration(integrationId) {
            try {
                const { data: integration } = await supabase
                    .from('ghl_integrations')
                    .select('*')
                    .eq('id', integrationId)
                    .single();

                if (!integration) {
                    alert('Integration not found');
                    return;
                }

                // TODO: Implement actual GHL API test
                alert(`Testing integration for Location ID: ${integration.location_id}\n\nThis would test the API connection and webhook setup.`);

                await logAdminActivity('integration_test', 'integration', integrationId, {
                    location_id: integration.location_id
                });

            } catch (error) {
                console.error('Error testing integration:', error);
                alert('Error testing integration');
            }
        }

        async function toggleIntegration(integrationId, currentStatus) {
            try {
                const newStatus = !currentStatus;
                const { error } = await supabase
                    .from('ghl_integrations')
                    .update({ is_active: newStatus })
                    .eq('id', integrationId);

                if (error) throw error;

                await logAdminActivity('integration_toggle', 'integration', integrationId, {
                    old_status: currentStatus,
                    new_status: newStatus
                });

                await loadIntegrationsTable();
                alert(`Integration ${newStatus ? 'enabled' : 'disabled'} successfully`);

            } catch (error) {
                console.error('Error toggling integration:', error);
                alert('Error updating integration status');
            }
        }

        async function deleteIntegration(integrationId) {
            if (!confirm('Are you sure you want to delete this integration? This cannot be undone.')) return;

            try {
                const { error } = await supabase
                    .from('ghl_integrations')
                    .delete()
                    .eq('id', integrationId);

                if (error) throw error;

                await logAdminActivity('integration_delete', 'integration', integrationId, {});

                await loadIntegrationsTable();
                alert('Integration deleted successfully');

            } catch (error) {
                console.error('Error deleting integration:', error);
                alert('Error deleting integration');
            }
        }

        // Utility Functions
        async function logAdminActivity(action, targetType, targetId, details) {
            try {
                await supabase
                    .from('admin_activity_log')
                    .insert({
                        admin_id: currentUser.id,
                        action: action,
                        target_type: targetType,
                        target_id: targetId,
                        details: details,
                        ip_address: null, // Could be populated with actual IP
                        user_agent: navigator.userAgent
                    });
            } catch (error) {
                console.error('Error logging admin activity:', error);
            }
        }

        function closeEditUserModal() {
            document.getElementById('editUserModal').classList.remove('show');
            document.body.style.overflow = 'auto';
        }

        function closeEditOrderModal() {
            document.getElementById('editOrderModal').classList.remove('show');
            document.body.style.overflow = 'auto';
        }

        // Field Mapping Modal Functions
        let ghlCustomFields = [];

        async function openFieldMappingModal() {
            const privateToken = document.getElementById('ghlPrivateToken').value;
            const locationId = document.getElementById('ghlLocationId').value;

            if (!privateToken || !locationId) {
                showPrivateTokenResult('Please configure Private Integration Token and Location ID first', 'error');
                return;
            }

            // Load GoHighLevel custom fields
            try {
                const response = await fetch('/api/ghl/get-custom-fields.js', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        privateToken,
                        locationId
                    })
                });

                const data = await response.json();

                if (data.success && data.customFields) {
                    ghlCustomFields = data.customFields;
                    populateFieldMapping();
                    document.getElementById('fieldMappingModal').classList.add('show');
                    document.body.style.overflow = 'hidden';
                } else {
                    showPrivateTokenResult('Failed to load GoHighLevel custom fields: ' + (data.message || 'Unknown error'), 'error');
                }

            } catch (error) {
                console.error('Error loading custom fields:', error);
                showPrivateTokenResult('Error loading GoHighLevel custom fields: ' + error.message, 'error');
            }
        }

        function populateFieldMapping() {
            // Standard GHL fields + custom fields
            const ghlStandardFields = [
                { id: 'firstName', name: 'First Name' },
                { id: 'lastName', name: 'Last Name' },
                { id: 'email', name: 'Email' },
                { id: 'phone', name: 'Phone' },
                { id: 'address1', name: 'Address' },
                { id: 'city', name: 'City' },
                { id: 'state', name: 'State' },
                { id: 'postalCode', name: 'Postal Code' },
                { id: 'country', name: 'Country' },
                { id: 'dateOfBirth', name: 'Date of Birth' },
                { id: 'companyName', name: 'Company Name' },
                { id: 'website', name: 'Website' }
            ];

            const allGhlFields = [...ghlStandardFields, ...ghlCustomFields.map(field => ({
                id: field.id,
                name: field.name + (field.type ? ` (${field.type})` : '')
            }))];

            const mappingContainer = document.getElementById('fieldMappingContainer');
            mappingContainer.innerHTML = '';

            // Form fields from our order form
            const formFields = [
                { category: 'User Profile', fields: [
                    { id: 'user_email', name: 'User Email', required: true },
                    { id: 'user_first_name', name: 'User First Name', required: true },
                    { id: 'user_last_name', name: 'User Last Name', required: true },
                    { id: 'user_phone', name: 'User Phone', required: true },
                    { id: 'user_api_key', name: 'User API Key', required: false },
                    { id: 'user_location_id', name: 'User Location ID', required: false },
                    { id: 'user_agency_name', name: 'User Agency Name', required: false }
                ]},
                { category: 'Individual Order Fields', fields: [
                    { id: 'individual_firstName', name: 'Individual First Name', required: true },
                    { id: 'individual_lastName', name: 'Individual Last Name', required: true },
                    { id: 'individual_contactEmail', name: 'Individual Contact Email', required: true },
                    { id: 'individual_contactPhone', name: 'Individual Contact Phone', required: true },
                    { id: 'individual_firstNameLicense', name: 'Individual License First Name', required: true },
                    { id: 'individual_lastNameLicense', name: 'Individual License Last Name', required: true },
                    { id: 'individual_consentEmail', name: 'Individual Consent Email', required: true },
                    { id: 'individual_consentPhone', name: 'Individual Consent Phone', required: true },
                    { id: 'individual_npn', name: 'Individual NPN', required: true }
                ]},
                { category: 'Agency Order Fields', fields: [
                    { id: 'agency_firstName', name: 'Agency Contact First Name', required: true },
                    { id: 'agency_lastName', name: 'Agency Contact Last Name', required: true },
                    { id: 'agency_contactEmail', name: 'Agency Contact Email', required: true },
                    { id: 'agency_contactPhone', name: 'Agency Contact Phone', required: true },
                    { id: 'agency_npn', name: 'Agency NPN', required: true },
                    { id: 'agency_name', name: 'Agency Name', required: true },
                    { id: 'agency_consentPhone', name: 'Agency Consent Phone', required: true },
                    { id: 'agency_consentEmail', name: 'Agency Consent Email', required: true }
                ]},
                { category: 'Order Details', fields: [
                    { id: 'order_id', name: 'Order ID', required: false, special: 'order_id' },
                    { id: 'order_type', name: 'Order Type (individual/agency)', required: false },
                    { id: 'lead_quantity', name: 'Lead Quantity', required: false },
                    { id: 'additional_carriers', name: 'Additional Carriers', required: false },
                    { id: 'invoice_email', name: 'Invoice Email', required: false },
                    { id: 'api_key', name: 'Order API Key', required: false }
                ]}
            ];

            formFields.forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'field-category';

                const categoryHeader = document.createElement('h4');
                categoryHeader.textContent = category.category;
                categoryHeader.style.cssText = 'margin: 20px 0 10px 0; font-size: 14px; font-weight: 600; color: #2c3e50; border-bottom: 1px solid #ecf0f1; padding-bottom: 5px;';
                categoryDiv.appendChild(categoryHeader);

                category.fields.forEach(field => {
                    const fieldRow = document.createElement('div');
                    fieldRow.className = 'field-mapping-row';
                    fieldRow.style.cssText = 'display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f8f9fa;';

                    const fieldLabel = document.createElement('div');
                    fieldLabel.className = 'form-field-label';
                    fieldLabel.style.cssText = 'flex: 1; font-size: 14px; color: #2c3e50;';
                    fieldLabel.innerHTML = `${field.name} ${field.required ? '<span style="color: #e74c3c;">*</span>' : ''}`;
                    if (field.special === 'order_id') {
                        fieldLabel.innerHTML += ' <span style="color: #f39c12; font-size: 12px; font-weight: bold;">[SPECIAL]</span>';
                    }

                    const fieldSelect = document.createElement('select');
                    fieldSelect.className = 'ghl-field-select';
                    fieldSelect.style.cssText = 'flex: 1; margin-left: 20px; padding: 8px 12px; border: 1px solid #e1e5e9; border-radius: 6px; font-size: 14px; background: white; cursor: pointer;';
                    fieldSelect.setAttribute('data-form-field', field.id);

                    // Add default option
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = field.special === 'order_id' ? 'Select field to store Order ID' : 'Select GoHighLevel field';
                    fieldSelect.appendChild(defaultOption);

                    // Add GHL fields
                    allGhlFields.forEach(ghlField => {
                        const option = document.createElement('option');
                        option.value = ghlField.id;
                        option.textContent = ghlField.name;
                        fieldSelect.appendChild(option);
                    });

                    fieldRow.appendChild(fieldLabel);
                    fieldRow.appendChild(fieldSelect);
                    categoryDiv.appendChild(fieldRow);
                });

                mappingContainer.appendChild(categoryDiv);
            });
        }

        function closeFieldMappingModal() {
            document.getElementById('fieldMappingModal').classList.remove('show');
            document.body.style.overflow = 'auto';
        }

        async function saveFieldMapping() {
            const mappings = {};
            const selects = document.querySelectorAll('.ghl-field-select');

            selects.forEach(select => {
                const formField = select.getAttribute('data-form-field');
                const ghlField = select.value;
                if (ghlField) {
                    mappings[formField] = ghlField;
                }
            });

            // Save mappings to database
            try {
                const { data, error } = await supabase
                    .from('admin_settings')
                    .upsert({
                        setting_key: 'field_mappings',
                        setting_value: JSON.stringify(mappings)
                    });

                if (error) throw error;

                showPrivateTokenResult('✅ Field mappings saved successfully!', 'success');
                closeFieldMappingModal();

            } catch (error) {
                console.error('Error saving field mappings:', error);
                alert('Error saving field mappings: ' + error.message);
            }
        }
    </script>

    <!-- Field Mapping Modal -->
    <div id="fieldMappingModal" class="modal">
        <div class="modal-content" style="max-width: 900px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid #e1e5e9; background: #f8f9fa;">
                <h2 style="margin: 0; font-size: 18px; font-weight: 600; color: #2c3e50;">Map Fields</h2>
                <button class="modal-close" onclick="closeFieldMappingModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #95a5a6; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">&times;</button>
            </div>

            <div style="padding: 24px;">
                <div style="background: #f8f9fa; border: 1px solid #e1e5e9; border-radius: 6px; padding: 16px; margin-bottom: 24px;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <div style="width: 16px; height: 16px; background: #f39c12; border-radius: 3px; display: flex; align-items: center; justify-content: center;">
                            <span style="color: white; font-size: 10px; font-weight: bold;">!</span>
                        </div>
                        <span style="font-size: 14px; color: #2c3e50; font-weight: 500;">Field Mapping Instructions</span>
                    </div>
                    <p style="margin: 0; font-size: 13px; color: #5a6c7d; line-height: 1.4;">
                        Map the fields in your order form to the corresponding GoHighLevel fields. Required fields marked with <span style="color: #e74c3c;">*</span> should be mapped to receive leads successfully. The <span style="color: #f39c12; font-weight: bold;">ORDER ID</span> field is special - it will store a unique identifier for each order.
                    </p>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                    <div>
                        <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 600; color: #2c3e50;">Form Fields</h3>
                        <p style="margin: 0; font-size: 14px; color: #7f8c8d;">Fields from your ACA Lead Order Form</p>
                    </div>
                    <div>
                        <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 600; color: #2c3e50;">GoHighLevel Fields</h3>
                        <p style="margin: 0; font-size: 14px; color: #7f8c8d;">Available fields in your GoHighLevel CRM</p>
                    </div>
                </div>

                <div id="fieldMappingContainer" style="border: 1px solid #e1e5e9; border-radius: 6px; background: white; padding: 16px;">
                    <!-- Field mappings will be populated here -->
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 24px; padding-top: 16px; border-top: 1px solid #e1e5e9;">
                    <div style="display: flex; align-items: center; gap: 8px; color: #f39c12; font-size: 14px;">
                        <div style="width: 16px; height: 16px; background: #f39c12; border-radius: 3px; display: flex; align-items: center; justify-content: center;">
                            <span style="color: white; font-size: 10px; font-weight: bold;">!</span>
                        </div>
                        <span>Map required fields to receive leads successfully</span>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button onclick="closeFieldMappingModal()" style="padding: 10px 20px; border: 1px solid #e1e5e9; background: white; color: #5a6c7d; border-radius: 6px; cursor: pointer; font-size: 14px;">Cancel</button>
                        <button onclick="saveFieldMapping()" style="padding: 10px 20px; border: none; background: #4f46e5; color: white; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">Confirm</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>
</html>