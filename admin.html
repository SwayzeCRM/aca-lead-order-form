<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACA Lead Order System - Admin</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            line-height: 1.5;
            color: #1f2937;
            background-color: #f5f5f5;
            padding: 24px 16px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 32px 40px;
            position: relative;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .header p {
            opacity: 0.9;
            font-size: 16px;
        }

        .admin-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #e74c3c;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .user-info {
            position: absolute;
            top: 50px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-email {
            font-size: 14px;
            opacity: 0.9;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .admin-nav {
            display: flex;
            gap: 0;
            background: #ecf0f1;
            border-bottom: 1px solid #e0e0e0;
        }

        .nav-tab {
            padding: 16px 24px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #7f8c8d;
            transition: all 0.2s ease;
            flex: 1;
            text-align: center;
        }

        .nav-tab.active {
            color: #2c3e50;
            background: white;
            border-bottom-color: #3498db;
        }

        .nav-tab:hover {
            color: #2c3e50;
            background: rgba(255, 255, 255, 0.7);
        }

        .admin-content {
            padding: 40px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 24px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-card.orders {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .stat-card.users {
            background: linear-gradient(135deg, #27ae60, #229954);
        }

        .stat-card.revenue {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .stat-number {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 8px;
            border-bottom: 2px solid #ecf0f1;
        }

        .table-container {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #2c3e50;
            border-bottom: 1px solid #e0e0e0;
            font-size: 14px;
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #f1f1f1;
            font-size: 14px;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-right: 8px;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-processing {
            background: #cce5ff;
            color: #004085;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .status-paid {
            background: #d4edda;
            color: #155724;
        }

        .role-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .role-admin {
            background: #ff6b6b;
            color: white;
        }

        .role-user {
            background: #4ecdc4;
            color: white;
        }

        .role-buyer {
            background: #45b7d1;
            color: white;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #34495e;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .settings-section {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .settings-section h3 {
            color: #2c3e50;
            margin-bottom: 16px;
            font-size: 16px;
            font-weight: 600;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .modal-header h3 {
            margin: 0;
            color: #2c3e50;
            font-size: 18px;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            text-align: right;
        }

        .close-btn {
            background: #95a5a6;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 12px;
        }

        .save-btn {
            background: #27ae60;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .admin-content {
                padding: 20px;
            }

            .admin-nav {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <span class="admin-badge">Admin</span>
            <h1>ACA Lead Order System</h1>
            <p>Administrative Dashboard</p>
            <div class="user-info">
                <span class="user-email" id="adminEmail"></span>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="admin-nav">
            <button class="nav-tab active" onclick="showAdminTab('overview')">Overview</button>
            <button class="nav-tab" onclick="showAdminTab('orders')">Orders</button>
            <button class="nav-tab" onclick="showAdminTab('users')">Users</button>
            <button class="nav-tab" onclick="showAdminTab('integrations')">Integrations</button>
            <button class="nav-tab" onclick="showAdminTab('settings')">Settings</button>
        </div>

        <div class="admin-content">
            <!-- Overview Tab -->
            <div id="overviewTab" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalOrders">-</div>
                        <div class="stat-label">Total Orders</div>
                    </div>
                    <div class="stat-card users">
                        <div class="stat-number" id="totalUsers">-</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                    <div class="stat-card orders">
                        <div class="stat-number" id="pendingOrders">-</div>
                        <div class="stat-label">Pending Orders</div>
                    </div>
                    <div class="stat-card revenue">
                        <div class="stat-number" id="totalRevenue">-</div>
                        <div class="stat-label">Total Revenue</div>
                    </div>
                </div>

                <h2 class="section-title">Recent Activity</h2>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>User</th>
                                <th>Action</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="recentActivity">
                            <tr>
                                <td colspan="5" class="loading">Loading recent activity...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Orders Tab -->
            <div id="ordersTab" class="tab-content">
                <h2 class="section-title">Order Management</h2>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>User</th>
                                <th>Type</th>
                                <th>Quantity</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTable">
                            <tr>
                                <td colspan="8" class="loading">Loading orders...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="usersTab" class="tab-content">
                <h2 class="section-title">User Management</h2>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Location ID</th>
                                <th>Status</th>
                                <th>Joined</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable">
                            <tr>
                                <td colspan="7" class="loading">Loading users...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Integrations Tab -->
            <div id="integrationsTab" class="tab-content">
                <h2 class="section-title">GoHighLevel Integrations</h2>

                <div class="settings-section">
                    <h3>Private Integration Token</h3>
                    <p style="color: #7f8c8d; font-size: 14px; margin-bottom: 16px;">
                        Use this for private GoHighLevel integrations. Private integrations work at the location level and require both a token and Location ID.
                    </p>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Private Integration Token</label>
                            <input type="password" id="ghlPrivateToken" placeholder="pit-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" style="font-family: monospace;">
                            <div class="help-text">Your private integration token (starts with "pit-")</div>
                        </div>
                        <div class="form-group">
                            <label>Location ID</label>
                            <input type="text" id="ghlLocationId" placeholder="ve9EPM428h8vShlRW1KT" style="font-family: monospace;">
                            <div class="help-text">The GoHighLevel Location ID for this integration</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button class="action-btn btn-primary" onclick="savePrivateIntegration()">Save Integration</button>
                        <button class="action-btn btn-warning" onclick="testContactsAPI()">Test Contacts API</button>
                        <button class="action-btn btn-success" onclick="testOpportunitiesAPI()">Test Opportunities API</button>
                        <button class="action-btn" style="background: #9b59b6; color: white;" onclick="testTagsAPI()">Test Tags API</button>
                    </div>
                    <div id="privateTokenResult" style="margin-top: 15px; padding: 12px; border-radius: 4px; display: none;"></div>
                </div>

                <div class="settings-section">
                    <h3>Order Workflow Automation</h3>
                    <p style="color: #7f8c8d; font-size: 14px; margin-bottom: 16px;">
                        Configure what happens automatically in GoHighLevel when a new order is placed.
                    </p>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="workflowEnabled" style="margin: 0;">
                            Enable Order Workflow Automation
                        </label>
                        <div class="help-text">Automatically perform actions in GoHighLevel when orders are placed</div>
                    </div>

                    <div id="workflowSettings" style="margin-top: 20px;">
                        <h4 style="margin-bottom: 16px; color: #2c3e50;">Workflow Actions</h4>

                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="createUpdateContact" style="margin: 0;">
                                Create/Update Contact
                            </label>
                            <div class="help-text">Create new contact or update existing contact with order information</div>
                        </div>

                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="addToPipeline" style="margin: 0;">
                                Add to Pipeline
                            </label>
                            <div class="help-text">Create opportunity in specified pipeline</div>
                            <div style="margin-top: 8px;">
                                <input type="text" id="pipelineId" placeholder="Pipeline ID (e.g., 7GoVuBJb4WadoAr0L5Q7)" style="margin-top: 4px;">
                                <div class="help-text">Get Pipeline ID from GoHighLevel → Opportunities → Pipeline Settings</div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="addTags" style="margin: 0;">
                                Add Tags
                            </label>
                            <div class="help-text">Add tags to contact when order is placed</div>
                            <div style="margin-top: 8px;">
                                <input type="text" id="orderTags" placeholder="e.g., new-order, aca-customer" style="margin-top: 4px;">
                                <div class="help-text">Comma-separated list of tags to add</div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Order Value Field</label>
                            <input type="text" id="orderValueField" placeholder="Custom field name for order value">
                            <div class="help-text">Custom field in GoHighLevel to store order total (optional)</div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 12px; margin-top: 20px;">
                        <button class="action-btn btn-primary" onclick="saveWorkflowSettings()">Save Workflow Settings</button>
                        <button class="action-btn btn-warning" onclick="testWorkflow()">Test Workflow</button>
                    </div>

                    <div id="workflowResult" style="margin-top: 15px; padding: 12px; border-radius: 4px; display: none;"></div>
                </div>

                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Location ID</th>
                                <th>Location Name</th>
                                <th>Status</th>
                                <th>Connected</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="integrationsTable">
                            <tr>
                                <td colspan="5" class="loading">Loading integrations...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settingsTab" class="tab-content">
                <h2 class="section-title">System Settings</h2>

                <div class="settings-section">
                    <h3>General Settings</h3>
                    <div class="form-group">
                        <label>Notification Email</label>
                        <input type="email" id="notificationEmail" placeholder="Admin notification email">
                    </div>
                    <div class="form-group">
                        <label>Webhook Secret</label>
                        <input type="text" id="webhookSecret" placeholder="Webhook validation secret">
                    </div>
                </div>

                <div class="settings-section">
                    <h3>Lead Processing</h3>
                    <div class="form-group">
                        <label>Default Pipeline ID</label>
                        <input type="text" id="defaultPipelineId" placeholder="GoHighLevel Pipeline ID">
                    </div>
                </div>

                <button class="action-btn btn-primary" onclick="saveSystemSettings()">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal-overlay" id="editUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit User</h3>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <input type="hidden" id="editUserId">
                    <div class="form-row">
                        <div class="form-group">
                            <label>First Name</label>
                            <input type="text" id="editFirstName">
                        </div>
                        <div class="form-group">
                            <label>Last Name</label>
                            <input type="text" id="editLastName">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="editEmail">
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="editPhone">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Role</label>
                            <select id="editRole">
                                <option value="user">User</option>
                                <option value="buyer">Buyer</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="editStatus">
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Location ID</label>
                        <input type="text" id="editLocationId">
                    </div>
                    <div class="form-group">
                        <label>API Key</label>
                        <input type="text" id="editApiKey">
                    </div>
                    <div class="form-group">
                        <label>Agency Name</label>
                        <input type="text" id="editAgencyName">
                    </div>
                    <div class="form-group">
                        <label>Admin Notes</label>
                        <textarea id="editNotes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="close-btn" onclick="closeEditUserModal()">Cancel</button>
                <button class="save-btn" onclick="saveUserChanges()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Edit Order Modal -->
    <div class="modal-overlay" id="editOrderModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Order</h3>
            </div>
            <div class="modal-body">
                <form id="editOrderForm">
                    <input type="hidden" id="editOrderId">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Status</label>
                            <select id="editOrderStatus">
                                <option value="pending">Pending</option>
                                <option value="invoiced">Invoiced</option>
                                <option value="paid">Paid</option>
                                <option value="processing">Processing</option>
                                <option value="delivered">Delivered</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Assigned Admin</label>
                            <select id="editAssignedAdmin">
                                <option value="">Not Assigned</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Admin Notes</label>
                        <textarea id="editOrderNotes" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Processing Notes</label>
                        <textarea id="editProcessingNotes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="close-btn" onclick="closeEditOrderModal()">Cancel</button>
                <button class="save-btn" onclick="saveOrderChanges()">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://nsypkyubepyjhectnbtx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zeXBreXViZXB5amhlY3RuYnR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzODE5NDUsImV4cCI6MjA3Mzk1Nzk0NX0.m8V1EP4oUSC5qhjGMcbvbDMsg8EebLVR9YXpJkYmASA';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;

        // Initialize admin dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeAuth();
            await loadDashboardData();
        });

        async function initializeAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = 'index.html';
                return;
            }

            // Load user data and verify admin role
            const { data: userData, error } = await supabase
                .from('users')
                .select('*')
                .eq('id', session.user.id)
                .single();

            if (error || !userData || userData.role !== 'admin') {
                alert('Access denied. Admin privileges required.');
                window.location.href = 'index.html';
                return;
            }

            currentUser = userData;
            document.getElementById('adminEmail').textContent = currentUser.email;
        }

        async function loadDashboardData() {
            await loadOverviewStats();
            await loadRecentActivity();
            await loadOrdersTable();
            await loadUsersTable();
            await loadIntegrationsTable();
            await loadSettings();
        }

        function showAdminTab(tabName) {
            // Update nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + 'Tab').classList.add('active');

            // Load data for specific tabs
            switch(tabName) {
                case 'orders':
                    loadOrdersTable();
                    break;
                case 'users':
                    loadUsersTable();
                    break;
                case 'integrations':
                    loadIntegrationsTable();
                    break;
                case 'settings':
                    loadSettings();
                    break;
            }
        }

        async function loadOverviewStats() {
            try {
                // Load total orders
                const { count: totalOrders } = await supabase
                    .from('orders')
                    .select('*', { count: 'exact', head: true });

                // Load total users
                const { count: totalUsers } = await supabase
                    .from('users')
                    .select('*', { count: 'exact', head: true });

                // Load pending orders
                const { count: pendingOrders } = await supabase
                    .from('orders')
                    .select('*', { count: 'exact', head: true })
                    .eq('status', 'pending');

                // Calculate total revenue (approximate)
                const { data: orders } = await supabase
                    .from('orders')
                    .select('lead_quantity');

                const priceMap = { 50: 1500, 100: 3000, 200: 6000, 400: 12000 };
                const totalRevenue = orders?.reduce((sum, order) => {
                    return sum + (priceMap[order.lead_quantity] || 0);
                }, 0) || 0;

                document.getElementById('totalOrders').textContent = totalOrders || 0;
                document.getElementById('totalUsers').textContent = totalUsers || 0;
                document.getElementById('pendingOrders').textContent = pendingOrders || 0;
                document.getElementById('totalRevenue').textContent = '$' + totalRevenue.toLocaleString();

            } catch (error) {
                console.error('Error loading overview stats:', error);
            }
        }

        async function loadRecentActivity() {
            try {
                const { data: activity, error } = await supabase
                    .from('admin_activity_log')
                    .select(`
                        *,
                        admin:admin_id(first_name, last_name, email)
                    `)
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (error) throw error;

                const tbody = document.getElementById('recentActivity');
                if (!activity || activity.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #7f8c8d;">No recent activity</td></tr>';
                    return;
                }

                tbody.innerHTML = activity.map(item => `
                    <tr>
                        <td>${new Date(item.created_at).toLocaleDateString()}</td>
                        <td>${item.target_type || 'System'}</td>
                        <td>${item.admin?.first_name ? `${item.admin.first_name} ${item.admin.last_name}` : item.admin?.email || 'System'}</td>
                        <td>${item.action}</td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${JSON.stringify(item.details || {})}</td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error('Error loading recent activity:', error);
                document.getElementById('recentActivity').innerHTML =
                    '<tr><td colspan="5" style="text-align: center; color: #e74c3c;">Error loading activity</td></tr>';
            }
        }

        async function loadOrdersTable() {
            try {
                const { data: orders, error } = await supabase
                    .from('orders')
                    .select(`
                        *,
                        user:user_id(first_name, last_name, email),
                        assigned_admin_user:assigned_admin(first_name, last_name, email)
                    `)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const tbody = document.getElementById('ordersTable');
                if (!orders || orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #7f8c8d;">No orders found</td></tr>';
                    return;
                }

                const priceMap = { 50: 1500, 100: 3000, 200: 6000, 400: 12000 };

                tbody.innerHTML = orders.map(order => `
                    <tr>
                        <td>#${order.id.substring(0, 8)}</td>
                        <td>${order.user?.first_name ? `${order.user.first_name} ${order.user.last_name}` : order.user?.email || 'Unknown'}</td>
                        <td>${order.order_type === 'individual' ? 'Individual' : 'Agency'}</td>
                        <td>${order.lead_quantity} leads</td>
                        <td>$${(priceMap[order.lead_quantity] || 0).toLocaleString()}</td>
                        <td><span class="status-badge status-${order.status}">${order.status}</span></td>
                        <td>${new Date(order.created_at).toLocaleDateString()}</td>
                        <td>
                            <button class="action-btn btn-primary" onclick="editOrder('${order.id}')">Edit</button>
                            <button class="action-btn btn-success" onclick="markOrderComplete('${order.id}')">Complete</button>
                        </td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error('Error loading orders:', error);
                document.getElementById('ordersTable').innerHTML =
                    '<tr><td colspan="8" style="text-align: center; color: #e74c3c;">Error loading orders</td></tr>';
            }
        }

        async function loadUsersTable() {
            try {
                const { data: users, error } = await supabase
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const tbody = document.getElementById('usersTable');
                if (!users || users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #7f8c8d;">No users found</td></tr>';
                    return;
                }

                tbody.innerHTML = users.map(user => `
                    <tr>
                        <td>${user.first_name && user.last_name ? `${user.first_name} ${user.last_name}` : 'Not provided'}</td>
                        <td>${user.email}</td>
                        <td><span class="role-badge role-${user.role}">${user.role}</span></td>
                        <td style="font-family: monospace; font-size: 12px;">${user.location_id}</td>
                        <td>${user.is_active !== false ? 'Active' : 'Inactive'}</td>
                        <td>${new Date(user.created_at).toLocaleDateString()}</td>
                        <td>
                            <button class="action-btn btn-primary" onclick="editUser('${user.id}')">Edit</button>
                            <button class="action-btn ${user.is_active !== false ? 'btn-warning' : 'btn-success'}"
                                    onclick="toggleUserStatus('${user.id}', ${user.is_active !== false})">
                                ${user.is_active !== false ? 'Deactivate' : 'Activate'}
                            </button>
                        </td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('usersTable').innerHTML =
                    '<tr><td colspan="7" style="text-align: center; color: #e74c3c;">Error loading users</td></tr>';
            }
        }

        async function loadIntegrationsTable() {
            try {
                const { data: integrations, error } = await supabase
                    .from('ghl_integrations')
                    .select('*')
                    .order('created_at', { ascending: false });

                const tbody = document.getElementById('integrationsTable');

                if (error) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #e74c3c;">Error loading integrations</td></tr>';
                    return;
                }

                if (!integrations || integrations.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #7f8c8d;">No integrations configured</td></tr>';
                    return;
                }

                tbody.innerHTML = integrations.map(integration => `
                    <tr>
                        <td style="font-family: monospace; font-size: 12px;">${integration.location_id}</td>
                        <td>${integration.location_name || 'Unknown'}</td>
                        <td><span class="status-badge ${integration.is_active ? 'status-completed' : 'status-pending'}">${integration.is_active ? 'Active' : 'Inactive'}</span></td>
                        <td>${new Date(integration.created_at).toLocaleDateString()}</td>
                        <td>
                            <button class="action-btn btn-primary" onclick="testIntegration('${integration.id}')">Test</button>
                            <button class="action-btn ${integration.is_active ? 'btn-warning' : 'btn-success'}"
                                    onclick="toggleIntegration('${integration.id}', ${integration.is_active})">
                                ${integration.is_active ? 'Disable' : 'Enable'}
                            </button>
                            <button class="action-btn btn-danger" onclick="deleteIntegration('${integration.id}')">Delete</button>
                        </td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error('Error loading integrations:', error);
                document.getElementById('integrationsTable').innerHTML =
                    '<tr><td colspan="5" style="text-align: center; color: #e74c3c;">Error loading integrations</td></tr>';
            }
        }

        async function loadSettings() {
            try {
                const { data: settings, error } = await supabase
                    .from('admin_settings')
                    .select('*');

                if (error) throw error;

                const settingsMap = {};
                settings?.forEach(setting => {
                    settingsMap[setting.setting_key] = setting.setting_value;
                });

                // Populate form fields
                document.getElementById('ghlPrivateToken').value = settingsMap.ghl_private_token || '';
                document.getElementById('ghlLocationId').value = settingsMap.ghl_location_id || '';
                document.getElementById('notificationEmail').value = settingsMap.notification_email || '';
                document.getElementById('webhookSecret').value = settingsMap.webhook_secret || '';
                document.getElementById('defaultPipelineId').value = settingsMap.default_pipeline_id || '';

                // Populate workflow settings
                document.getElementById('workflowEnabled').checked = settingsMap.workflow_enabled === 'true';
                document.getElementById('createUpdateContact').checked = settingsMap.workflow_create_contact === 'true';
                document.getElementById('addToPipeline').checked = settingsMap.workflow_add_pipeline === 'true';
                document.getElementById('addTags').checked = settingsMap.workflow_add_tags === 'true';
                document.getElementById('pipelineId').value = settingsMap.workflow_pipeline_id || '';
                document.getElementById('orderTags').value = settingsMap.workflow_order_tags || '';
                document.getElementById('orderValueField').value = settingsMap.workflow_order_value_field || '';

            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // Private Integration Functions
        async function savePrivateIntegration() {
            try {
                const privateToken = document.getElementById('ghlPrivateToken').value;
                const locationId = document.getElementById('ghlLocationId').value;

                if (!privateToken || !locationId) {
                    showPrivateTokenResult('Please enter both Private Integration Token and Location ID', 'error');
                    return;
                }

                if (!privateToken.startsWith('pit-')) {
                    showPrivateTokenResult('Private integration tokens should start with "pit-"', 'error');
                    return;
                }

                const updates = [
                    { setting_key: 'ghl_private_token', setting_value: privateToken },
                    { setting_key: 'ghl_location_id', setting_value: locationId }
                ];

                for (const update of updates) {
                    await supabase
                        .from('admin_settings')
                        .upsert(update);
                }

                await logAdminActivity('private_integration_saved', 'settings', null, {
                    token_length: privateToken.length,
                    location_id: locationId,
                    token_prefix: privateToken.substring(0, 8) + '...'
                });

                showPrivateTokenResult('Private integration saved successfully', 'success');

            } catch (error) {
                console.error('Error saving private integration:', error);
                showPrivateTokenResult('Error saving integration: ' + error.message, 'error');
            }
        }

        async function testContactsAPI() {
            try {
                const privateToken = document.getElementById('ghlPrivateToken').value;
                const locationId = document.getElementById('ghlLocationId').value;

                if (!privateToken || !locationId) {
                    showPrivateTokenResult('Please enter both Private Integration Token and Location ID first', 'error');
                    return;
                }

                showPrivateTokenResult('Testing Contacts API...', 'info');

                // Test the Contacts API via Vercel API route
                const response = await fetch('/api/ghl/test-contacts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        privateToken,
                        locationId
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showPrivateTokenResult(`${data.message}\n\nScopes confirmed: ${data.data.scopes.join(', ')}\n\nAPI Endpoint: ${data.data.endpoint}\nLocation ID: ${locationId}`, 'success');

                    await logAdminActivity('contacts_api_test_success', 'settings', null, {
                        contacts_found: data.data.contactCount,
                        location_id: locationId,
                        response_status: response.status
                    });

                } else {
                    showPrivateTokenResult(`${data.message}\n\nPlease check your token, location ID, and permissions.`, 'error');

                    await logAdminActivity('contacts_api_test_failed', 'settings', null, {
                        response_status: response.status,
                        location_id: locationId,
                        error: data.error
                    });
                }

            } catch (error) {
                console.error('Error testing contacts API:', error);
                showPrivateTokenResult(`❌ Contacts API Test Failed!\n\nError: ${error.message}\n\nThis could be due to CORS restrictions. The token may still work server-side.`, 'error');
            }
        }

        async function testOpportunitiesAPI() {
            try {
                const privateToken = document.getElementById('ghlPrivateToken').value;
                const locationId = document.getElementById('ghlLocationId').value;

                if (!privateToken || !locationId) {
                    showPrivateTokenResult('Please enter both Private Integration Token and Location ID first', 'error');
                    return;
                }

                showPrivateTokenResult('Testing Opportunities API...', 'info');

                // Test the Opportunities API via Vercel API route
                const response = await fetch('/api/ghl/test-opportunities', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        privateToken,
                        locationId
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showPrivateTokenResult(`${data.message}\n\nScopes confirmed: ${data.data.scopes.join(', ')}\n\nAPI Endpoint: ${data.data.endpoint}\nLocation ID: ${locationId}`, 'success');

                    await logAdminActivity('opportunities_api_test_success', 'settings', null, {
                        opportunities_found: data.data.opportunityCount,
                        location_id: locationId,
                        response_status: response.status
                    });

                } else {
                    showPrivateTokenResult(`${data.message}\n\nPlease check your token, location ID, and permissions.`, 'error');

                    await logAdminActivity('opportunities_api_test_failed', 'settings', null, {
                        response_status: response.status,
                        location_id: locationId,
                        error: data.error
                    });
                }

            } catch (error) {
                console.error('Error testing opportunities API:', error);
                showPrivateTokenResult(`❌ Opportunities API Test Failed!\n\nError: ${error.message}\n\nThis could be due to CORS restrictions. The token may still work server-side.`, 'error');
            }
        }

        async function testTagsAPI() {
            try {
                const privateToken = document.getElementById('ghlPrivateToken').value;
                const locationId = document.getElementById('ghlLocationId').value;

                if (!privateToken || !locationId) {
                    showPrivateTokenResult('Please enter both Private Integration Token and Location ID first', 'error');
                    return;
                }

                showPrivateTokenResult('Testing Tags API...', 'info');

                // Test the Tags API via Vercel API route
                const response = await fetch('/api/ghl/test-tags', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        privateToken,
                        locationId
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showPrivateTokenResult(`${data.message}\n\nScopes confirmed: ${data.data.scopes.join(', ')}\n\nAPI Endpoint: ${data.data.endpoint}\nLocation ID: ${locationId}`, 'success');

                    await logAdminActivity('tags_api_test_success', 'settings', null, {
                        tags_found: data.data.tagCount,
                        location_id: locationId,
                        response_status: response.status
                    });

                } else {
                    showPrivateTokenResult(`${data.message}\n\nPlease check your token, location ID, and permissions.`, 'error');

                    await logAdminActivity('tags_api_test_failed', 'settings', null, {
                        response_status: response.status,
                        location_id: locationId,
                        error: data.error
                    });
                }

            } catch (error) {
                console.error('Error testing tags API:', error);
                showPrivateTokenResult(`❌ Tags API Test Failed!\n\nError: ${error.message}\n\nThis could be due to CORS restrictions. The token may still work server-side.`, 'error');
            }
        }

        function showPrivateTokenResult(message, type) {
            const resultDiv = document.getElementById('privateTokenResult');
            resultDiv.style.display = 'block';
            resultDiv.style.whiteSpace = 'pre-line';

            switch(type) {
                case 'success':
                    resultDiv.style.backgroundColor = '#d4edda';
                    resultDiv.style.borderColor = '#c3e6cb';
                    resultDiv.style.color = '#155724';
                    break;
                case 'error':
                    resultDiv.style.backgroundColor = '#f8d7da';
                    resultDiv.style.borderColor = '#f5c6cb';
                    resultDiv.style.color = '#721c24';
                    break;
                case 'info':
                    resultDiv.style.backgroundColor = '#cce5ff';
                    resultDiv.style.borderColor = '#b8daff';
                    resultDiv.style.color = '#004085';
                    break;
            }

            resultDiv.style.border = '1px solid';
            resultDiv.textContent = message;

            if (type !== 'error') {
                setTimeout(() => {
                    resultDiv.style.display = 'none';
                }, 15000);
            }
        }

        async function logout() {
            await supabase.auth.signOut();
            window.location.href = 'index.html';
        }

        // User Management Functions
        async function editUser(userId) {
            try {
                const { data: user, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', userId)
                    .single();

                if (error) throw error;

                // Populate form
                document.getElementById('editUserId').value = user.id;
                document.getElementById('editFirstName').value = user.first_name || '';
                document.getElementById('editLastName').value = user.last_name || '';
                document.getElementById('editEmail').value = user.email || '';
                document.getElementById('editPhone').value = user.phone || '';
                document.getElementById('editRole').value = user.role || 'user';
                document.getElementById('editStatus').value = user.is_active !== false ? 'true' : 'false';
                document.getElementById('editLocationId').value = user.location_id || '';
                document.getElementById('editApiKey').value = user.api_key || '';
                document.getElementById('editAgencyName').value = user.agency_name || '';
                document.getElementById('editNotes').value = user.notes || '';

                document.getElementById('editUserModal').classList.add('show');
                document.body.style.overflow = 'hidden';

            } catch (error) {
                console.error('Error loading user:', error);
                alert('Error loading user details');
            }
        }

        async function saveUserChanges() {
            try {
                const userId = document.getElementById('editUserId').value;
                const updateData = {
                    first_name: document.getElementById('editFirstName').value,
                    last_name: document.getElementById('editLastName').value,
                    email: document.getElementById('editEmail').value,
                    phone: document.getElementById('editPhone').value,
                    role: document.getElementById('editRole').value,
                    is_active: document.getElementById('editStatus').value === 'true',
                    location_id: document.getElementById('editLocationId').value,
                    api_key: document.getElementById('editApiKey').value,
                    agency_name: document.getElementById('editAgencyName').value,
                    notes: document.getElementById('editNotes').value
                };

                const { error } = await supabase
                    .from('users')
                    .update(updateData)
                    .eq('id', userId);

                if (error) throw error;

                // Log admin activity
                await logAdminActivity('user_update', 'user', userId, updateData);

                closeEditUserModal();
                await loadUsersTable();
                alert('User updated successfully');

            } catch (error) {
                console.error('Error updating user:', error);
                alert('Error updating user: ' + error.message);
            }
        }

        async function toggleUserStatus(userId, currentStatus) {
            try {
                const newStatus = !currentStatus;
                const { error } = await supabase
                    .from('users')
                    .update({ is_active: newStatus })
                    .eq('id', userId);

                if (error) throw error;

                await logAdminActivity('user_status_toggle', 'user', userId, {
                    old_status: currentStatus,
                    new_status: newStatus
                });

                await loadUsersTable();
                alert(`User ${newStatus ? 'activated' : 'deactivated'} successfully`);

            } catch (error) {
                console.error('Error toggling user status:', error);
                alert('Error updating user status');
            }
        }

        // Order Management Functions
        async function editOrder(orderId) {
            try {
                const { data: order, error } = await supabase
                    .from('orders')
                    .select('*')
                    .eq('id', orderId)
                    .single();

                if (error) throw error;

                // Load admin users for assignment dropdown
                const { data: admins } = await supabase
                    .from('users')
                    .select('id, first_name, last_name, email')
                    .eq('role', 'admin');

                const adminSelect = document.getElementById('editAssignedAdmin');
                adminSelect.innerHTML = '<option value="">Not Assigned</option>' +
                    (admins || []).map(admin =>
                        `<option value="${admin.id}" ${order.assigned_admin === admin.id ? 'selected' : ''}>
                            ${admin.first_name && admin.last_name ? `${admin.first_name} ${admin.last_name}` : admin.email}
                        </option>`
                    ).join('');

                // Populate form
                document.getElementById('editOrderId').value = order.id;
                document.getElementById('editOrderStatus').value = order.status;
                document.getElementById('editOrderNotes').value = order.admin_notes || '';
                document.getElementById('editProcessingNotes').value = order.processing_notes || '';

                document.getElementById('editOrderModal').classList.add('show');
                document.body.style.overflow = 'hidden';

            } catch (error) {
                console.error('Error loading order:', error);
                alert('Error loading order details');
            }
        }

        async function saveOrderChanges() {
            try {
                const orderId = document.getElementById('editOrderId').value;
                const oldStatus = document.getElementById('editOrderStatus').dataset.oldValue;
                const newStatus = document.getElementById('editOrderStatus').value;

                const updateData = {
                    status: newStatus,
                    assigned_admin: document.getElementById('editAssignedAdmin').value || null,
                    admin_notes: document.getElementById('editOrderNotes').value,
                    processing_notes: document.getElementById('editProcessingNotes').value
                };

                const { error } = await supabase
                    .from('orders')
                    .update(updateData)
                    .eq('id', orderId);

                if (error) throw error;

                // Log status change if status changed
                if (oldStatus && oldStatus !== newStatus) {
                    await supabase
                        .from('order_status_history')
                        .insert({
                            order_id: orderId,
                            old_status: oldStatus,
                            new_status: newStatus,
                            changed_by: currentUser.id,
                            change_reason: 'Admin update'
                        });
                }

                await logAdminActivity('order_update', 'order', orderId, updateData);

                closeEditOrderModal();
                await loadOrdersTable();
                await loadOverviewStats();
                alert('Order updated successfully');

            } catch (error) {
                console.error('Error updating order:', error);
                alert('Error updating order: ' + error.message);
            }
        }

        async function markOrderComplete(orderId) {
            if (!confirm('Mark this order as completed?')) return;

            try {
                const { error } = await supabase
                    .from('orders')
                    .update({ status: 'completed' })
                    .eq('id', orderId);

                if (error) throw error;

                await logAdminActivity('order_complete', 'order', orderId, { status: 'completed' });

                await loadOrdersTable();
                await loadOverviewStats();
                alert('Order marked as completed');

            } catch (error) {
                console.error('Error completing order:', error);
                alert('Error updating order status');
            }
        }

        // Settings Functions

        async function saveSystemSettings() {
            try {
                const updates = [
                    { setting_key: 'notification_email', setting_value: document.getElementById('notificationEmail').value },
                    { setting_key: 'webhook_secret', setting_value: document.getElementById('webhookSecret').value },
                    { setting_key: 'default_pipeline_id', setting_value: document.getElementById('defaultPipelineId').value }
                ];

                for (const update of updates) {
                    await supabase
                        .from('admin_settings')
                        .upsert(update);
                }

                await logAdminActivity('system_settings_update', 'settings', null, updates);

                alert('System settings saved successfully');

            } catch (error) {
                console.error('Error saving system settings:', error);
                alert('Error saving settings: ' + error.message);
            }
        }

        // Workflow Settings Functions
        async function saveWorkflowSettings() {
            try {
                const workflowEnabled = document.getElementById('workflowEnabled').checked;
                const createUpdateContact = document.getElementById('createUpdateContact').checked;
                const addToPipeline = document.getElementById('addToPipeline').checked;
                const addTags = document.getElementById('addTags').checked;
                const pipelineId = document.getElementById('pipelineId').value;
                const orderTags = document.getElementById('orderTags').value;
                const orderValueField = document.getElementById('orderValueField').value;

                const updates = [
                    { setting_key: 'workflow_enabled', setting_value: workflowEnabled.toString() },
                    { setting_key: 'workflow_create_contact', setting_value: createUpdateContact.toString() },
                    { setting_key: 'workflow_add_pipeline', setting_value: addToPipeline.toString() },
                    { setting_key: 'workflow_add_tags', setting_value: addTags.toString() },
                    { setting_key: 'workflow_pipeline_id', setting_value: pipelineId },
                    { setting_key: 'workflow_order_tags', setting_value: orderTags },
                    { setting_key: 'workflow_order_value_field', setting_value: orderValueField }
                ];

                for (const update of updates) {
                    await supabase
                        .from('admin_settings')
                        .upsert(update);
                }

                await logAdminActivity('workflow_settings_update', 'settings', null, {
                    workflow_enabled: workflowEnabled,
                    actions: {
                        create_contact: createUpdateContact,
                        add_pipeline: addToPipeline,
                        add_tags: addTags
                    }
                });

                showWorkflowResult('✅ Workflow settings saved successfully!', 'success');

            } catch (error) {
                console.error('Error saving workflow settings:', error);
                showWorkflowResult('❌ Error saving workflow settings: ' + error.message, 'error');
            }
        }

        async function testWorkflow() {
            try {
                const workflowEnabled = document.getElementById('workflowEnabled').checked;

                if (!workflowEnabled) {
                    showWorkflowResult('⚠️ Workflow is disabled. Enable it first to test.', 'error');
                    return;
                }

                const privateToken = document.getElementById('ghlPrivateToken').value;
                const locationId = document.getElementById('ghlLocationId').value;

                if (!privateToken || !locationId) {
                    showWorkflowResult('❌ Please configure Private Integration Token and Location ID first', 'error');
                    return;
                }

                showWorkflowResult('🧪 Testing workflow with sample order data...', 'info');

                // Test data
                const testOrderData = {
                    customerEmail: 'test@example.com',
                    customerName: 'Test Customer',
                    orderTotal: 99.99,
                    orderId: 'TEST-' + Date.now()
                };

                // Check which actions are enabled
                const actions = [];
                if (document.getElementById('createUpdateContact').checked) actions.push('✓ Create/Update Contact');
                if (document.getElementById('addToPipeline').checked) actions.push('✓ Add to Pipeline');
                if (document.getElementById('addTags').checked) actions.push('✓ Add Tags');

                if (actions.length === 0) {
                    showWorkflowResult('⚠️ No workflow actions are enabled. Please enable at least one action.', 'error');
                    return;
                }

                // Simulate success (in real implementation, this would call GoHighLevel APIs)
                setTimeout(() => {
                    showWorkflowResult(`✅ Workflow Test Successful!

Test Order: ${testOrderData.orderId}
Customer: ${testOrderData.customerName}
Total: $${testOrderData.orderTotal}

Actions that would be performed:
${actions.join('\n')}

Note: This is a simulation. Real orders will trigger actual GoHighLevel API calls.`, 'success');
                }, 2000);

            } catch (error) {
                console.error('Error testing workflow:', error);
                showWorkflowResult('❌ Error testing workflow: ' + error.message, 'error');
            }
        }

        function showWorkflowResult(message, type) {
            const resultDiv = document.getElementById('workflowResult');
            resultDiv.style.display = 'block';
            resultDiv.textContent = message;
            resultDiv.className = '';

            if (type === 'success') {
                resultDiv.style.backgroundColor = '#d4edda';
                resultDiv.style.color = '#155724';
                resultDiv.style.borderLeft = '4px solid #28a745';
            } else if (type === 'error') {
                resultDiv.style.backgroundColor = '#f8d7da';
                resultDiv.style.color = '#721c24';
                resultDiv.style.borderLeft = '4px solid #dc3545';
            } else if (type === 'info') {
                resultDiv.style.backgroundColor = '#cce7ff';
                resultDiv.style.color = '#004085';
                resultDiv.style.borderLeft = '4px solid #007bff';
            }

            // Auto-hide after 10 seconds for success/info messages
            if (type !== 'error') {
                setTimeout(() => {
                    resultDiv.style.display = 'none';
                }, 10000);
            }
        }

        // Integration Functions
        async function testIntegration(integrationId) {
            try {
                const { data: integration } = await supabase
                    .from('ghl_integrations')
                    .select('*')
                    .eq('id', integrationId)
                    .single();

                if (!integration) {
                    alert('Integration not found');
                    return;
                }

                // TODO: Implement actual GHL API test
                alert(`Testing integration for Location ID: ${integration.location_id}\n\nThis would test the API connection and webhook setup.`);

                await logAdminActivity('integration_test', 'integration', integrationId, {
                    location_id: integration.location_id
                });

            } catch (error) {
                console.error('Error testing integration:', error);
                alert('Error testing integration');
            }
        }

        async function toggleIntegration(integrationId, currentStatus) {
            try {
                const newStatus = !currentStatus;
                const { error } = await supabase
                    .from('ghl_integrations')
                    .update({ is_active: newStatus })
                    .eq('id', integrationId);

                if (error) throw error;

                await logAdminActivity('integration_toggle', 'integration', integrationId, {
                    old_status: currentStatus,
                    new_status: newStatus
                });

                await loadIntegrationsTable();
                alert(`Integration ${newStatus ? 'enabled' : 'disabled'} successfully`);

            } catch (error) {
                console.error('Error toggling integration:', error);
                alert('Error updating integration status');
            }
        }

        async function deleteIntegration(integrationId) {
            if (!confirm('Are you sure you want to delete this integration? This cannot be undone.')) return;

            try {
                const { error } = await supabase
                    .from('ghl_integrations')
                    .delete()
                    .eq('id', integrationId);

                if (error) throw error;

                await logAdminActivity('integration_delete', 'integration', integrationId, {});

                await loadIntegrationsTable();
                alert('Integration deleted successfully');

            } catch (error) {
                console.error('Error deleting integration:', error);
                alert('Error deleting integration');
            }
        }

        // Utility Functions
        async function logAdminActivity(action, targetType, targetId, details) {
            try {
                await supabase
                    .from('admin_activity_log')
                    .insert({
                        admin_id: currentUser.id,
                        action: action,
                        target_type: targetType,
                        target_id: targetId,
                        details: details,
                        ip_address: null, // Could be populated with actual IP
                        user_agent: navigator.userAgent
                    });
            } catch (error) {
                console.error('Error logging admin activity:', error);
            }
        }

        function closeEditUserModal() {
            document.getElementById('editUserModal').classList.remove('show');
            document.body.style.overflow = 'auto';
        }

        function closeEditOrderModal() {
            document.getElementById('editOrderModal').classList.remove('show');
            document.body.style.overflow = 'auto';
        }
    </script>
</body>
</html>